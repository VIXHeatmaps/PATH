<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discord Login + R2 Upload</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 920px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 40px; margin: 0 0 16px; }
    .card { border: 1px solid var(--border); border-radius: 14px; padding: 18px; margin: 16px 0; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button, input, a.btn { font-size: 16px; }
    a.btn, button { padding: 8px 14px; border: 1px solid var(--border); border-radius: 10px; text-decoration: none; cursor: pointer; background: #fff; }
    a.btn:hover, button:hover { background: #fafafa; }
    code { background:#f6f7f8; padding:2px 6px; border-radius:6px; }
    #status { color: var(--muted); margin-top: 8px; }
    #result { margin-top: 8px; }
    .ok { color: #16a34a; }
    .warn { color: #b45309; }
    .err { color: #dc2626; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    #preview { border:1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 10px; white-space: pre-wrap; max-height: 320px; overflow:auto; }
    img.preview { max-width: 100%; height: auto; display:block; }
  </style>
</head>
<body>
  <h1>Discord Login + R2 Upload</h1>

  <div class="card">
    <h3>1) Login</h3>
    <p>If status says <em>Not logged in</em>, click this:</p>
    <a class="btn" href="/api/auth/discord/start">Login with Discord</a>
    <div id="status">Checking login status…</div>
  </div>

  <div class="card">
    <h3>2) Upload a file</h3>
    <div class="row">
      <input type="file" id="fileInput" />
      <button id="uploadBtn">Upload</button>
    </div>
    <div id="result"></div>
  </div>

  <div class="card">
    <h3>3) My files</h3>
    <div class="row">
      <button id="refreshBtn">Refresh list</button>
      <div id="listStatus" class="warn"></div>
    </div>
    <table id="filesTable" style="display:none">
      <thead>
        <tr>
          <th style="width:55%">Key</th>
          <th style="width:15%">Size</th>
          <th style="width:15%">Modified</th>
          <th style="width:15%">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="pager" class="row" style="margin-top:8px; display:none">
      <button id="nextPageBtn">Next page</button>
    </div>
    <div id="preview"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const resultEl = document.getElementById('result');

    const refreshBtn = document.getElementById('refreshBtn');
    const listStatus = document.getElementById('listStatus');
    const filesTable = document.getElementById('filesTable');
    const filesTbody = filesTable.querySelector('tbody');
    const pager = document.getElementById('pager');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const previewEl = document.getElementById('preview');

    let cursor = null; // pagination for list-files

    // --- auth status check ---
    async function checkLogin() {
      try {
        const resp = await fetch('/api/upload-url', { credentials: 'include' });
        if (resp.status === 400) {
          statusEl.textContent = 'Logged in ✔';
          statusEl.className = 'ok';
          return true;
        } else if (resp.status === 401) {
          statusEl.textContent = 'Not logged in';
          statusEl.className = 'warn';
          return false;
        } else {
          statusEl.textContent = 'Status unknown (' + resp.status + ')';
          statusEl.className = 'warn';
          return false;
        }
      } catch {
        statusEl.textContent = 'Status check failed';
        statusEl.className = 'err';
        return false;
      }
    }

    // --- helpers to call our APIs ---
    async function getUploadUrl(filename, contentType) {
      const u = new URL('/api/upload-url', window.location.origin);
      u.searchParams.set('filename', filename);
      u.searchParams.set('contentType', contentType || 'application/octet-stream');
      const resp = await fetch(u.toString(), { credentials: 'include' });
      if (!resp.ok) throw new Error(await resp.text());
      return resp.json();
    }

    async function getFileUrl(key) {
      const u = new URL('/api/file-url', window.location.origin);
      u.searchParams.set('key', key);
      const resp = await fetch(u.toString(), { credentials: 'include' });
      if (!resp.ok) throw new Error(await resp.text());
      return resp.json(); // { url }
    }

    async function listFilesPage(nextCursor) {
      const u = new URL('/api/list-files', window.location.origin);
      if (nextCursor) u.searchParams.set('cursor', nextCursor);
      const resp = await fetch(u.toString(), { credentials: 'include' });
      if (!resp.ok) throw new Error(await resp.text());
      return resp.json(); // { items, isTruncated, cursor }
    }

    // --- UI actions ---
    uploadBtn.onclick = async () => {
      resultEl.textContent = '';
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        resultEl.textContent = 'Pick a file first.';
        resultEl.className = 'warn';
        return;
      }
      const ok = await checkLogin();
      if (!ok) {
        resultEl.innerHTML = 'Not logged in. Click <a href="/api/auth/discord/start">Login with Discord</a> first.';
        resultEl.className = 'warn';
        return;
      }
      try {
        resultEl.textContent = 'Requesting upload URL…';
        const { url, key, user } = await getUploadUrl(f.name, f.type || 'application/octet-stream');

        resultEl.textContent = 'Uploading…';
        const put = await fetch(url, { method: 'PUT', headers: { 'Content-Type': f.type || 'application/octet-stream' }, body: f });
        if (!put.ok) throw new Error('Upload failed: ' + put.status);

        resultEl.innerHTML = `Done ✅ Uploaded as <code>${key}</code>${user ? ` (user ${user})` : ''}.`;
        resultEl.className = 'ok';
        // Refresh the list
        cursor = null;
        await refreshList();
      } catch (err) {
        resultEl.textContent = String(err);
        resultEl.className = 'err';
      }
    };

    async function refreshList() {
      previewEl.textContent = '';
      listStatus.textContent = 'Loading…';
      filesTable.style.display = 'none';
      pager.style.display = 'none';
      filesTbody.innerHTML = '';
      try {
        const data = await listFilesPage(null);
        renderList(data);
      } catch (e) {
        listStatus.textContent = 'Error: ' + e.message;
        listStatus.className = 'err';
      }
    }

    function renderList(data) {
      listStatus.textContent = data.items.length ? '' : 'No files yet.';
      listStatus.className = data.items.length ? '' : 'warn';
      filesTable.style.display = data.items.length ? 'table' : 'none';
      pager.style.display = data.isTruncated ? 'flex' : 'none';
      cursor = data.isTruncated ? data.cursor : null;
      filesTbody.innerHTML = '';
      for (const it of data.items) {
        const tr = document.createElement('tr');
        const keyTd = document.createElement('td'); keyTd.innerHTML = `<code>${it.key}</code>`;
        const sizeTd = document.createElement('td'); sizeTd.textContent = humanBytes(it.size);
        const whenTd = document.createElement('td'); whenTd.textContent = niceDate(it.lastModified);
        const actTd = document.createElement('td'); actTd.className = 'actions';

        const openBtn = mkBtn('Open', async () => {
          const { url } = await getFileUrl(it.key);
          window.open(url, '_blank');
        });
        const previewBtn = mkBtn('Preview', async () => {
          previewEl.textContent = 'Loading preview…';
          const { url } = await getFileUrl(it.key);
          // crude type guess by extension
          const isImg = /\.(png|jpe?g|gif|webp|svg)$/i.test(it.key);
          const isText = /\.(txt|md|csv|json|log|html|js|ts|css)$/i.test(it.key);
          if (isImg) {
            previewEl.innerHTML = `<img class="preview" src="${url}" alt="preview" />`;
          } else if (isText) {
            const r = await fetch(url);
            const t = await r.text();
            previewEl.textContent = t.slice(0, 100000); // keep UI snappy
          } else {
            previewEl.textContent = 'Preview not supported for this type. Use Open.';
          }
        });

        actTd.append(openBtn, previewBtn);
        tr.append(keyTd, sizeTd, whenTd, actTd);
        filesTbody.appendChild(tr);
      }
    }

    nextPageBtn.onclick = async () => {
      if (!cursor) return;
      listStatus.textContent = 'Loading next page…';
      try {
        const data = await listFilesPage(cursor);
        renderList(data);
      } catch (e) {
        listStatus.textContent = 'Error: ' + e.message;
        listStatus.className = 'err';
      }
    };

    refreshBtn.onclick = async () => { cursor = null; await refreshList(); };

    // helpers
    function mkBtn(label, onClick) {
      const b = document.createElement('button');
      b.textContent = label;
      b.onclick = onClick;
      return b;
    }
    function humanBytes(n) {
      if (n < 1024) return n + ' B';
      const k = 1024; const i = Math.floor(Math.log(n)/Math.log(k));
      const units = ['B','KB','MB','GB','TB']; return (n/Math.pow(k,i)).toFixed(1) + ' ' + units[i];
    }
    function niceDate(s) { try { return new Date(s).toLocaleString(); } catch { return s; } }

    // initial load
    (async () => {
      const ok = await checkLogin();
      if (ok) await refreshList();
    })();
  </script>
</body>
</html>
