<!-- ===================== BEGIN BLOCK I: SCRIPT ================================ -->
<script>
  /* ---------- State ---------- */
  let outputs = Array(9).fill('');
  let debugMode = false;
  let apiKey = localStorage.getItem('path_api_key') || '';

  /* ---------- Defaults (Name + Persona + Temperature) ---------- */
  const defaultConfigs = Array.from({length:9}, (_,i)=>({
    name: `Bot ${i+1}`,
    model: i===3 || i===8 ? 'gpt-5-mini' : (i===6 ? 'gpt-5-nano' : 'gpt-5'),
    persona: '',
    temperature: 0.7,
    reasoning: 'minimal',
    verbosity: 'low',
    maxtok: 30
  }));

  /* ---------- Helpers ---------- */
  function addDebugLog(message){
    if (!debugMode) return;
    let p = document.getElementById('debugPanel');
    if (!p){
      p = document.createElement('pre');
      p.id = 'debugPanel';
      p.className = 'debug-panel active';
      document.querySelector('.input-section').insertAdjacentElement('afterend', p);
    }
    const ts = new Date().toISOString().substr(11,8);
    p.textContent += `[${ts}] ${message}\n`;
    p.scrollTop = p.scrollHeight;
  }
  function showError(message){
    const el=document.getElementById('errorMessage');
    el.textContent=message; el.classList.add('active');
    setTimeout(()=>el.classList.remove('active'), 5000);
  }
  function showToast(message){
    const t=document.getElementById('toast');
    t.textContent=message; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800);
  }
  function updateApiKeyButton(){
    const btn=document.getElementById('apiKeyBtn');
    if (!btn) return;
    if (apiKey){ btn.classList.add('configured'); btn.textContent='ðŸ” API'; }
    else { btn.classList.remove('configured'); btn.textContent='ðŸ”‘ API'; }
  }
  function openApiKeyModal(){
    document.getElementById('apiKeyModal').classList.add('active');
    document.getElementById('apiKeyInput').value=apiKey;
  }
  function closeApiKeyModal(){ document.getElementById('apiKeyModal').classList.remove('active'); }
  function saveApiKey(){
    apiKey=document.getElementById('apiKeyInput').value||'';
    localStorage.setItem('path_api_key', apiKey);
    updateApiKeyButton();
    closeApiKeyModal();
    showToast('API key saved');
  }

  /* ---------- Persist per-bot settings ---------- */
  const VAR_KEYS = ['name','model','persona','temperature','reasoning','verbosity','maxtok'];
  function cardKey(i,k){ return `path_card_${i}_${k}`; }
  function filesKeyGlobal(){ return `path_global_files`; }
  function filesKeyForBot(i){ return `path_card_${i}_files`; }

  function loadCardSettings(index){
    try{
      VAR_KEYS.forEach(k=>{
        const el = document.getElementById(`${k}-${index}`);
        if (!el) return;
        const saved = localStorage.getItem(cardKey(index,k));
        if (saved !== null){
          if (k==='temperature' || k==='maxtok'){ el.value = +saved; }
          else { el.value = saved; }
        }
      });
      renderFileList(document.getElementById(`botFilesList-${index}`), loadFilesForBot(index), 'bot', index);
      syncTempControl(index);
      updateVarSummary(index);
    }catch(e){ addDebugLog(`Settings load error [${index}]: ${e}`); }
  }
  function handleSettingEvent(e){
    const t=e && e.target; if(!t||!t.id) return;
    const m=t.id.match(/^(name|model|persona|temperature|reasoning|verbosity|maxtok)-(\d+)$/);
    if (!m) return;
    const key=m[1], i=parseInt(m[2],10);
    localStorage.setItem(cardKey(i,key), t.value);
    if (key==='model'){ applyModelDefaults(i, t.value); syncTempControl(i); }
    updateVarSummary(i);
  }
  document.addEventListener('change', handleSettingEvent);
  document.addEventListener('input',  handleSettingEvent);

  /* ---------- Files: global + per-bot ---------- */
  function loadGlobalFiles(){ try{ return JSON.parse(localStorage.getItem(filesKeyGlobal())||'[]'); }catch{ return []; } }
  function saveGlobalFiles(list){ localStorage.setItem(filesKeyGlobal(), JSON.stringify(list)); }
  function loadFilesForBot(i){ try{ return JSON.parse(localStorage.getItem(filesKeyForBot(i))||'[]'); }catch{ return []; } }
  function saveFilesForBot(i,list){ localStorage.setItem(filesKeyForBot(i), JSON.stringify(list)); }

  async function uploadToR2(file){
    const res = await fetch('/api/upload-url', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ filename:file.name, contentType:file.type||'text/plain' })
    });
    if(!res.ok) throw new Error('Failed to get signed upload URL');
    const { url, key } = await res.json();
    const put = await fetch(url, { method:'PUT', headers:{'Content-Type': file.type||'text/plain'}, body:file });
    if(!put.ok) throw new Error('Upload to storage failed');
    return { key, name:file.name, size:file.size };
  }
  async function fetchFileTextByKey(key){
    const res = await fetch('/api/file-url?key=' + encodeURIComponent(key), { credentials:'include' });
    if(!res.ok) throw new Error('file-url failed');
    const { url } = await res.json();
    return await fetch(url).then(r=>r.text());
  }
  function renderFileList(container, list, scope, index){
    if (!container) return;
    if (!Array.isArray(list) || list.length===0){ container.innerHTML = `<div style="color:#777">No files.</div>`; return; }
    container.innerHTML = list.map((f, idx)=>`
      <div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-top:1px dashed #eee;">
        <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          <strong>${f.name}</strong> <span style="color:#999">(${f.size||'?'} bytes)</span>
        </div>
        <button class="link-btn" type="button" data-scope="${scope}" data-index="${index||''}" data-fileidx="${idx}" data-act="preview">Preview</button>
        <button class="link-btn" type="button" data-scope="${scope}" data-index="${index||''}" data-fileidx="${idx}" data-act="remove">Remove</button>
      </div>
    `).join('');
  }
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button.link-btn'); if(!btn) return;
    const act = btn.dataset.act; if(!act) return;

    if (act==='preview'){
      const scope=btn.dataset.scope, i=parseInt(btn.dataset.index||'-1',10), fi=parseInt(btn.dataset.fileidx,10);
      const list = scope==='global' ? loadGlobalFiles() : loadFilesForBot(i);
      const file = list[fi]; if (!file) return;
      try{
        const text = await fetchFileTextByKey(file.key);
        alert((text||'').slice(0,2000));
      }catch(err){ alert('Preview failed: '+err.message); }
    }
    if (act==='remove'){
      const scope=btn.dataset.scope, i=parseInt(btn.dataset.index||'-1',10), fi=parseInt(btn.dataset.fileidx,10);
      const list = scope==='global' ? loadGlobalFiles() : loadFilesForBot(i);
      list.splice(fi,1);
      if (scope==='global'){ saveGlobalFiles(list); renderFileList(document.getElementById('globalFilesList'), list, 'global'); }
      else { saveFilesForBot(i, list); renderFileList(document.getElementById(`botFilesList-${i}`), list, 'bot', i); }
    }
  });

  /* ---------- Model defaults & temperature support ---------- */
  function getModelDefaults(model){
    const m=(model||'').toLowerCase();
    return m.startsWith('gpt-5') ? { reasoning:'minimal', verbosity:'low', maxtok:30 } :
                                   { reasoning:'medium',  verbosity:'medium', maxtok:30 };
  }
  function tempSupported(model){ return !(model||'').toLowerCase().startsWith('gpt-5'); }
  function syncTempControl(index){
    const model = document.getElementById(`model-${index}`)?.value || '';
    const tempEl = document.getElementById(`temperature-${index}`);
    if (!tempEl) return;
    const supported = tempSupported(model);
    tempEl.disabled = !supported;
    tempEl.title = supported ? 'Higher = more varied' : 'Not used by gpt-5 models';
  }
  function applyModelDefaults(index, model){
    const d=getModelDefaults(model);
    const rSel=document.getElementById(`reasoning-${index}`);
    const vSel=document.getElementById(`verbosity-${index}`);
    const tInp=document.getElementById(`maxtok-${index}`);
    if (rSel) rSel.value=d.reasoning;
    if (vSel) vSel.value=d.verbosity;
    if (tInp) tInp.value=d.maxtok;
    updateVarSummary(index);
  }

  /* ---------- Cards ---------- */
  function getVarSummary(index){
    const name = document.getElementById(`name-${index}`)?.value || `Bot ${index+1}`;
    const model= document.getElementById(`model-${index}`)?.value || '';
    const tempEl = document.getElementById(`temperature-${index}`);
    const tempVal = tempEl ? (tempEl.disabled ? 'â€”' : tempEl.value) : 'â€”';
    const r    = document.getElementById(`reasoning-${index}`)?.value || '';
    const v    = document.getElementById(`verbosity-${index}`)?.value || '';
    const cap  = document.getElementById(`maxtok-${index}`)?.value || 'auto';
    return `${name} Â· ${model} Â· T:${tempVal} Â· r:${r} Â· v:${v} Â· cap:${cap}`;
  }
  function updateVarSummary(index){
    const el=document.getElementById(`varssum-${index}`);
    if (el) el.textContent=getVarSummary(index);
  }
  function toggleVars(index){
    const s=document.getElementById(`settings-${index}`);
    const b=document.getElementById(`varsbar-${index}`);
    if (!s||!b) return;
    if (s.classList.contains('collapsed')){ s.classList.remove('collapsed'); b.classList.add('open'); }
    else { s.classList.add('collapsed'); b.classList.remove('open'); }
  }

  function createOutputCard(index){
    const cfg=defaultConfigs[index];
    const card=document.createElement('div');
    card.className='output-card';
    card.id=`output-${index}`;
    card.innerHTML=`
      <div class="num-badge">${index+1}.</div>
      <button class="refresh-btn" id="refresh-${index}" title="Run this bot">â†»</button>
      <div class="output-content" id="content-${index}" title="Click to append to prompt">Ready to generateâ€¦</div>

      <div class="vars-bar" id="varsbar-${index}">
        <span class="chev">â–¸</span><span id="varssum-${index}"></span>
      </div>

      <div class="output-settings collapsed" id="settings-${index}">
        <div class="settings-grid">

          <div class="setting-group" style="grid-column:1/-1">
            <label class="setting-label">Bot Name</label>
            <input id="name-${index}" value="${cfg.name}" placeholder="Name this bot" />
          </div>

          <div class="setting-group">
            <label class="setting-label">Model</label>
            <select id="model-${index}">
              <option value="gpt-5" ${cfg.model==='gpt-5'?'selected':''}>gpt-5</option>
              <option value="gpt-5-mini" ${cfg.model==='gpt-5-mini'?'selected':''}>gpt-5-mini</option>
              <option value="gpt-5-nano" ${cfg.model==='gpt-5-nano'?'selected':''}>gpt-5-nano</option>
              <option value="gpt-5-thinking">gpt-5-thinking</option>
              <option value="gpt-5-thinking-mini">gpt-5-thinking-mini</option>
              <option value="gpt-5-thinking-nano">gpt-5-thinking-nano</option>
              <option value="gpt-4-turbo-preview">GPT-4 Turbo (Fallback)</option>
              <option value="gpt-4">GPT-4 (Fallback)</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fallback)</option>
            </select>
          </div>

          <div class="setting-group">
            <label class="setting-label">Temperature <span style="color:#999">(0â€“2)</span></label>
            <input id="temperature-${index}" type="number" step="0.1" min="0" max="2" value="${cfg.temperature}" />
          </div>

          <div class="setting-group">
            <label class="setting-label">Reasoning Effort</label>
            <select id="reasoning-${index}">
              <option value="minimal" ${cfg.reasoning==='minimal'?'selected':''}>minimal</option>
              <option value="low"     ${cfg.reasoning==='low'?'selected':''}>low</option>
              <option value="medium"  ${cfg.reasoning==='medium'?'selected':''}>medium</option>
              <option value="high"    ${cfg.reasoning==='high'?'selected':''}>high</option>
            </select>
          </div>

          <div class="setting-group">
            <label class="setting-label">Verbosity</label>
            <select id="verbosity-${index}">
              <option value="low"    ${cfg.verbosity==='low'?'selected':''}>low</option>
              <option value="medium" ${cfg.verbosity==='medium'?'selected':''}>medium</option>
              <option value="high"   ${cfg.verbosity==='high'?'selected':''}>high</option>
            </select>
          </div>

          <div class="setting-group">
            <label class="setting-label">Max tokens (hard cap)</label>
            <input id="maxtok-${index}" type="number" min="1" step="1" value="${cfg.maxtok}" />
          </div>

          <div class="setting-group" style="grid-column:1/-1">
            <label class="setting-label">Persona</label>
            <textarea id="persona-${index}" placeholder="" style="min-height:140px"></textarea>
          </div>

          <div class="setting-group" style="grid-column:1/-1">
            <label class="setting-label">Bot Files</label>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <input id="botFileInput-${index}" type="file" multiple />
              <button type="button" class="link-btn" id="uploadBotBtn-${index}">Upload to this bot</button>
            </div>
            <div id="botFilesList-${index}" style="margin-top:8px; font-size:12px;"></div>
          </div>

        </div>
      </div>
    `;

    // wiring
    card.querySelector(`#refresh-${index}`).addEventListener('click', ()=>refreshOutput(index));
    card.querySelector(`#varsbar-${index}`).addEventListener('click', ()=>toggleVars(index));
    card.querySelector(`#content-${index}`).addEventListener('click', ()=>appendOutput(index));
    const modelSel = card.querySelector(`#model-${index}`);
    modelSel.addEventListener('change', (e)=> { applyModelDefaults(index, e.target.value); syncTempControl(index); });
    card.querySelector(`#uploadBotBtn-${index}`).addEventListener('click', async ()=>{
      const inp=card.querySelector(`#botFileInput-${index}`); if(!inp||!inp.files||!inp.files.length) return;
      const current=loadFilesForBot(index);
      for(const f of inp.files){ try{ const meta=await uploadToR2(f); current.push(meta); }
        catch(e){ showError('Bot file upload failed: '+e.message); } }
      saveFilesForBot(index,current);
      renderFileList(card.querySelector(`#botFilesList-${index}`), current, 'bot', index);
      inp.value='';
    });

    return card;
  }

  function initializeOutputCards(){
    const grid=document.getElementById('outputsGrid');
    grid.innerHTML='';
    for (let i=0;i<9;i++){
      const card = createOutputCard(i);
      grid.appendChild(card);
      applyModelDefaults(i, defaultConfigs[i].model);
      loadCardSettings(i);
    }
  }

  /* ---------- Build context text from files ---------- */
  async function buildContextText(index){
    const globalFiles = loadGlobalFiles();
    const botFiles    = loadFilesForBot(index);
    const all = [...globalFiles, ...botFiles];
    if (all.length===0) return '';
    let total = 0, parts = [];
    for(const f of all){
      try{
        let t = await fetchFileTextByKey(f.key);
        if (!t) continue;
        t = t.slice(0, 4000);
        total += t.length; if (total > 8000) break;
        parts.push(`--- BEGIN FILE: ${f.name}\n${t}\n--- END FILE: ${f.name}`);
      }catch(e){}
    }
    return parts.join('\n\n');
  }

  /* ---------- API glue ---------- */
  function extractTextFromResponse(responseData){
    try{
      if (responseData?.output_text) return responseData.output_text;
      if (Array.isArray(responseData?.output)){
        const msg = responseData.output.find(x=>x.type==='message');
        if (msg?.content?.length){
          const t = msg.content.find(x=>x.type==='output_text');
          if (t?.text) return t.text;
          return msg.content.map(c=>c.text||c.content||'').join('\n');
        }
      }
      if (Array.isArray(responseData?.choices)){
        return responseData.choices[0]?.message?.content || responseData.choices[0]?.text || '';
      }
    }catch{}
    return '';
  }

  async function refreshOutput(index){
    if (!apiKey){ openApiKeyModal(); return; }

    const out  = document.getElementById(`content-${index}`);
    const name = document.getElementById(`name-${index}`).value || `Bot ${index+1}`;
    const model= document.getElementById(`model-${index}`).value;
    const temp = parseFloat(document.getElementById(`temperature-${index}`).value||'0.7');
    const reas = document.getElementById(`reasoning-${index}`).value;
    const verb = document.getElementById(`verbosity-${index}`).value;
    const cap  = parseInt(document.getElementById(`maxtok-${index}`).value||'0',10) || null;
    const persona = document.getElementById(`persona-${index}`).value || '';
    const prompt = document.getElementById('prompt').value || '';

    const btn=document.getElementById(`refresh-${index}`);
    btn.classList.add('spinning');
    out.classList.remove('error','success');
    out.textContent = `${name} is thinkingâ€¦`;

    try{
      const filesContext = await buildContextText(index);
      const sys = persona ? persona : 'You are a helpful assistant.';
      const userMsg = (filesContext ? `You may consult these references:\n\n${filesContext}\n\n` : '') +
                      (prompt ? `User input:\n${prompt}` : 'No additional user input was provided.');

      let textOut = '';
      if (model.startsWith('gpt-5')){
        // Responses API: DO NOT send temperature (unsupported for gpt-5*)
        const body = { model, input: `${sys}\n\n${userMsg}`, reasoning:{effort: reas}, text:{verbosity: verb} };
        if (cap) body.max_output_tokens = cap;
        const r = await fetch('https://api.openai.com/v1/responses', {
          method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const raw = await r.text(); let data; try{ data=JSON.parse(raw);}catch{ data={output_text:raw}; }
        if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
        textOut = (extractTextFromResponse(data)||'').trim();
      } else {
        // Chat Completions: temperature is supported
        const body = {
          model,
          messages: [
            { role:'system', content: sys },
            { role:'user',   content: userMsg }
          ],
          temperature: temp
        };
        if (cap) body.max_tokens = cap;
        const r = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
        textOut = (data?.choices?.[0]?.message?.content||'').trim();
      }

      outputs[index] = textOut || 'No output';
      out.textContent = outputs[index];
      out.classList.add('success');
    }catch(err){
      out.textContent = `Error: ${err.message||String(err)}`;
      out.classList.add('error');
    }finally{
      btn.classList.remove('spinning');
    }
  }

  async function generateOutputs(){
    if (!apiKey){ openApiKeyModal(); return; }
    const prompt=document.getElementById('prompt').value.trim();
    if (!prompt){ showError('Please enter text'); return; }
    const tasks=[];
    for (let i=0;i<9;i++){
      document.getElementById(`content-${i}`).textContent='Generatingâ€¦';
      tasks.push(refreshOutput(i));
    }
    await Promise.all(tasks);
  }

  function appendOutput(index){
    if (!outputs[index]) return;
    const prompt=document.getElementById('prompt');
    const sep = prompt.value.trim() ? ' // ' : '';
    prompt.value += sep + outputs[index];
    prompt.scrollTop = prompt.scrollHeight;
    showToast('Text appended to prompt');
  }

  /* ---------- Global UI wiring ---------- */
  window.addEventListener('DOMContentLoaded', ()=>{
    // Header buttons
    document.getElementById('apiKeyBtn').addEventListener('click', openApiKeyModal);
    document.getElementById('debugBtn').addEventListener('click', ()=>{
      debugMode = !debugMode;
      let p = document.getElementById('debugPanel');
      if (debugMode && !p){ p = document.createElement('pre'); p.id='debugPanel'; p.className='debug-panel active'; document.querySelector('.input-section').insertAdjacentElement('afterend', p); }
      if (p){ p.classList.toggle('active', debugMode); }
    });
    document.getElementById('filesBtn').addEventListener('click', ()=>{
      document.getElementById('globalFilesPanel').classList.toggle('active');
    });

    // Global files list + uploader
    renderFileList(document.getElementById('globalFilesList'), loadGlobalFiles(), 'global');
    const gBtn = document.getElementById('uploadGlobalBtn');
    const gInp = document.getElementById('globalFileInput');
    if (gBtn && gInp){
      gBtn.addEventListener('click', async ()=>{
        if (!gInp.files || !gInp.files.length) return;
        const cur = loadGlobalFiles();
        for(const f of gInp.files){ try{ const meta=await uploadToR2(f); cur.push(meta); }catch(e){ showError('Global upload failed: '+e.message); } }
        saveGlobalFiles(cur);
        renderFileList(document.getElementById('globalFilesList'), cur, 'global');
        gInp.value='';
      });
    }

    // Enter = run all
    const ta = document.getElementById('prompt');
    ta.addEventListener('keydown', (e)=>{
      if (e.key==='Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey){
        e.preventDefault(); generateOutputs();
      }
    });

    // Build cards
    initializeOutputCards();
    updateApiKeyButton();
  });

  // numeric hotkeys 1..9 to append
  document.addEventListener('keydown', (e)=>{
    const ae=document.activeElement; const tag=(ae && ae.tagName||'').toLowerCase();
    const isOtherInput = (tag==='input') || (tag==='textarea' && ae.id!=='prompt') || (ae && ae.isContentEditable);
    if (isOtherInput || e.ctrlKey||e.metaKey||e.altKey) return;
    const k=e.key; if (k>='1'&&k<='9'){ e.preventDefault(); appendOutput(parseInt(k,10)-1); }
  });
</script>
<!-- ===================== END BLOCK I: SCRIPT ================================== -->
