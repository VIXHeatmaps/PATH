<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===================== BEGIN BLOCK A: LOGIN GATE (Discord) ===================== -->
  <style id="login-gate-style">html{visibility:hidden}</style>
  <script>
  (async () => {
    try {
      const resp = await fetch('/api/upload-url', { credentials: 'include' });
      if (resp.status === 401) {
        // Not logged in ‚Üí send to Discord login; your callback is already set to return to /path/
        location.href = '/api/auth/discord/start';
        return;
      }
    } catch (e) {}
    document.documentElement.style.visibility = 'visible';
  })();
  </script>
  <!-- ===================== END BLOCK A: LOGIN GATE (Discord) ======================= -->

  <!-- ===================== BEGIN BLOCK B: BASE PAGE METADATA ======================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PATH ‚Äì Parallel Adaptive Text Helper</title>
  <!-- ===================== END BLOCK B: BASE PAGE METADATA ========================= -->

  <!-- ===================== BEGIN BLOCK C: STYLES =================================== -->
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1600px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:20px}
    .title-section{display:flex;align-items:baseline;gap:10px}
    h1{color:#667eea;font-size:1.2em;font-weight:600;margin:0}
    .subtitle{color:#999;font-size:.85em;font-weight:300}
    .version{color:#bbb;font-size:.75em;font-family:monospace}
    .top-actions{display:flex;align-items:center;gap:10px}

    .link-btn{background:none;border:none;color:#666;font-size:.85em;cursor:pointer;padding:6px 10px;border-radius:8px}
    .link-btn:hover{background:#f0f0f0}
    .link-btn.configured{color:#2e7d32}

    textarea::placeholder{color:#9aa0a6}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .input-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px}
    .input-group{margin-bottom:15px}
    label{display:block;margin-bottom:8px;color:#555;font-weight:600}
    textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;resize:vertical;min-height:120px;transition:border-color .3s}
    textarea:focus{outline:none;border-color:#667eea}

    .controls-row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
    .controls-row .sp2{grid-column:span 2}
    .controls-row .sp3{grid-column:span 3}
    .controls-row .sp6{grid-column:1/-1}
    select,input[type="text"],input[type="number"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}

    .files-panel{background:#fff;border:1px dashed #ddd;border-radius:12px;padding:12px;margin:10px 0}
    .file-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border:1px solid #eee;border-radius:8px;margin-top:6px;background:#fafafa}
    .file-row small{color:#666}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eef;color:#445;margin-left:8px;font-size:12px}

    .gen-row{display:flex;gap:15px;align-items:center}
    .generate-btn{padding:12px 40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s}
    .generate-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
    .generate-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

    .debug-toggle{padding:8px 16px;background:#fff;border:1px solid #ddd;border-radius:6px;font-size:14px;cursor:pointer}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:30px;border-radius:12px;width:90%;max-width:500px}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end}
    .modal-btn{padding:10px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer}
    .modal-btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}

    .outputs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(480px,1fr));gap:20px;margin-top:20px}
    .output-card{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:20px;position:relative}
    .num-badge{position:absolute;top:10px;left:12px;font-size:12px;color:#9aa2b1;font-weight:600;user-select:none}
    .output-content{background:#f8f9fa;padding:15px;border-radius:8px;min-height:150px;max-height:300px;overflow-y:auto;white-space:pre-wrap;font-family:'Monaco','Menlo',monospace;font-size:14px;line-height:1.5}
    .output-content.error{background:#ffebee;color:#c62828}
    .output-content.success{background:#e8f5e9}

    .error-message{color:#d32f2f;padding:10px;background:#ffebee;border-radius:6px;margin-top:10px;display:none}
    .error-message.active{display:block}

    .toast{position:fixed;bottom:30px;right:30px;background:#4CAF50;color:#fff;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:all .3s;z-index:1001}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
  <!-- ===================== END BLOCK C: STYLES ===================================== -->
</head>
<body>
  <!-- ===================== BEGIN BLOCK D: HEADER =================================== -->
  <div class="container">
    <div class="header">
      <div class="title-section">
        <h1>PATH</h1>
        <span class="subtitle">Parallel Adaptive Text Helper</span>
      </div>
      <div class="top-actions">
        <button class="link-btn" id="apiKeyBtn" onclick="openApiKeyModal()" title="API Key">üîê API</button>
        <button class="link-btn" onclick="toggleDebug()" title="Debug">üõ† Debug</button>
        <span class="version">v0.30_editable</span>
      </div>
    </div>
  <!-- ===================== END BLOCK D: HEADER ===================================== -->

  <!-- ===================== BEGIN BLOCK E: MAIN PROMPT ============================== -->
    <div class="input-section">
      <div class="input-group">
        <label for="prompt">Your prompt (shared by all bots)</label>
        <textarea id="prompt" placeholder="Type your question/instructions‚Ä¶ Then click Generate."></textarea>
      </div>

      <!-- Global knowledge files + instructions -->
      <div class="input-group">
        <label>Global Knowledge Files</label>
        <div class="files-panel" id="globalFilesPanel">
          <div style="display:flex;gap:10px;align-items:center">
            <input type="file" id="globalFileInput" multiple />
            <button class="link-btn" onclick="uploadGlobalFiles()">Upload to Global</button>
            <small>Text/Markdown only for now. Max ~500KB per file.</small>
          </div>
          <div id="globalFilesList"></div>
          <div style="margin-top:10px">
            <label class="sr-only" for="globalFileInstructions">Global File Instructions</label>
            <textarea id="globalFileInstructions" placeholder="How should bots use global files? e.g., 'Keep in mind these facts' or 'Use these as reference context'"></textarea>
          </div>
        </div>
      </div>

      <!-- run controls -->
      <div class="gen-row">
        <button class="generate-btn" onclick="generateOutputs()">Generate</button>
        <div id="loadingSpinner"></div>
      </div>

      <div class="error-message" id="errorMessage"></div>
    </div>
  <!-- ===================== END BLOCK E: MAIN PROMPT ================================ -->

  <!-- ===================== BEGIN BLOCK F: OUTPUT GRID (9 bots) ===================== -->
    <div class="outputs-grid" id="outputsGrid"></div>
  </div>
  <!-- ===================== END BLOCK F: OUTPUT GRID ================================ -->

  <!-- ===================== BEGIN BLOCK G: API KEY MODAL ============================ -->
  <div id="apiKeyModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-bottom:12px">OpenAI API Key</h3>
      <input type="password" id="apiKeyInput" placeholder="sk-..." style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px" />
      <div class="modal-footer" style="margin-top:12px">
        <button class="modal-btn" onclick="closeApiKeyModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="saveApiKey()">Save</button>
      </div>
    </div>
  </div>
  <!-- ===================== END BLOCK G: API KEY MODAL ============================== -->

  <!-- ===================== BEGIN BLOCK H: TOAST ==================================== -->
  <div id="toast" class="toast">Saved</div>
  <!-- ===================== END BLOCK H: TOAST ====================================== -->

  <!-- ===================== BEGIN BLOCK I: SCRIPT =================================== -->
  <script>
  // -------- Persistence helpers --------
  const LS = {
    get(k, def){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def; }catch(_){ return def; } },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} }
  };

  // -------- App State --------
  let apiKey = localStorage.getItem('path_api_key') || '';
  let debugMode = false;

  // Per-bot defaults
  const defaultConfigs = Array.from({length:9}).map((_,i)=>({
    name: `Bot ${i+1}`,
    model: 'gpt-5',
    reasoning: 'minimal',
    verbosity: 'low',
    maxtok: 30,
    role: '',
    task: '',
    style: ([
      'Write in a concise, narrative style',
      'Write in an analytical, essay-like style',
      'Write in a punchy, engaging copywriting style',
      'Write in plain, accessible English',
      'Write in a technical, precise style',
      'Write in a thoughtful, storytelling style',
      'Write in a casual, conversational blog style',
      'Write in a journalistic, news-reporting style',
      'Write in a poetic, lyrical style'
    ])[i],
    fileInstructions: '',
    useGlobalFiles: true,
    autoContinue: false,
    botFiles: []  // array of R2 keys
  }));

  // Load persisted per-bot configs
  const BOT_KEY = i => `path_bot_${i}`;
  let bots = defaultConfigs.map((cfg,i)=> ({...cfg, ...(LS.get(BOT_KEY(i), {}))}));

  // Global files + instructions
  let globalFiles = LS.get('path_global_files', []);
  let globalFileInstructions = LS.get('path_global_file_instructions','');

  // Outputs and timers
  let outputs = Array(9).fill('');
  let continuationTimers = Array(9).fill(null);
  let lastPrompts = Array(9).fill('');
  let globalPaused = false;
  const CONTINUE_TOKENS = 30;

  // -------- UI boot --------
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('globalFileInstructions').value = globalFileInstructions || '';
    renderGlobalFiles();
    initializeOutputCards();
    updateApiKeyButton();
  });

  // -------- API Key modal --------
  function openApiKeyModal(){ document.getElementById('apiKeyModal').classList.add('active'); document.getElementById('apiKeyInput').value=apiKey; }
  function closeApiKeyModal(){ document.getElementById('apiKeyModal').classList.remove('active'); }
  function saveApiKey(){ apiKey=document.getElementById('apiKeyInput').value; localStorage.setItem('path_api_key',apiKey); updateApiKeyButton(); closeApiKeyModal(); toast('API key saved'); }
  function updateApiKeyButton(){ const btn=document.getElementById('apiKeyBtn'); if(!btn) return; if(apiKey){btn.classList.add('configured')} else {btn.classList.remove('configured')} }

  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
  function showError(message){ const el=document.getElementById('errorMessage'); el.textContent=message; el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),5000); }

  // -------- Global files --------
  async function uploadGlobalFiles(){
    const input = document.getElementById('globalFileInput');
    if (!input.files || input.files.length===0) return;
    for (const file of input.files){
      // Text/Markdown only for now
      if(!/^text\/|markdown/.test(file.type) && !file.name.endsWith('.txt') && !file.name.endsWith('.md')){
        showError(`Unsupported type: ${file.name}`);
        continue;
      }
      if (file.size > 500*1024) { showError(`Too large: ${file.name}`); continue; }

      const key = await uploadToR2(file);
      if (key){ globalFiles.push(key); LS.set('path_global_files', globalFiles); }
    }
    input.value = ''; renderGlobalFiles();
  }

  function renderGlobalFiles(){
    const list = document.getElementById('globalFilesList');
    list.innerHTML = '';
    if (!globalFiles.length){ list.innerHTML = '<small>No global files uploaded yet.</small>'; return; }
    globalFiles.forEach((key, idx)=>{
      const row = document.createElement('div');
      row.className='file-row';
      const name = key.split('/').pop();
      row.innerHTML = `<div><strong>${name}</strong><span class="badge">global</span><br><small>${key}</small></div>
        <div>
          <button class="link-btn" onclick="previewFile('${encodeURIComponent(key)}')">Preview</button>
          <button class="link-btn" onclick="removeGlobalFile(${idx})">Remove</button>
        </div>`;
      list.appendChild(row);
    });
  }
  async function previewFile(keyEnc){
    try{
      const r = await fetch('/api/file-url?key='+keyEnc);
      const j = await r.json();
      const t = await (await fetch(j.url)).text();
      alert((t||'').slice(0,2000)); // simple preview
    }catch(e){ showError('Preview failed'); }
  }
  function removeGlobalFile(i){
    globalFiles.splice(i,1);
    LS.set('path_global_files', globalFiles);
    renderGlobalFiles();
  }
  document.getElementById('globalFileInstructions').addEventListener('input', (e)=>{
    globalFileInstructions = e.target.value || '';
    LS.set('path_global_file_instructions', globalFileInstructions);
  });

  // -------- R2 upload helper (uses your /api/upload-url) --------
  async function uploadToR2(file){
    const resp = await fetch('/api/upload-url', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ filename: file.name, contentType: file.type || 'text/plain' })
    });
    if(!resp.ok){ showError('Upload URL error'); return null; }
    const {url, key} = await resp.json();
    const put = await fetch(url, { method:'PUT', headers:{'Content-Type': file.type || 'text/plain'}, body: file });
    if(!put.ok){ showError('Upload failed'); return null; }
    return key;
  }

  // -------- Output grid (9 bots) --------
  function initializeOutputCards(){
    const grid = document.getElementById('outputsGrid'); grid.innerHTML='';
    for (let i=0;i<9;i++){ grid.appendChild(createOutputCard(i)); }
  }

  function createOutputCard(index){
    const cfg = bots[index];
    const card = document.createElement('div'); card.className='output-card'; card.id=`output-${index}`;
    card.innerHTML = `
      <div class="num-badge">${index+1}.</div>

      <div class="controls-row sp6">
        <div class="sp3">
          <label>Bot Name</label>
          <input type="text" id="name-${index}" value="${escapeHtml(cfg.name)}" />
        </div>
        <div>
          <label>Model</label>
          <select id="model-${index}">
            <option value="gpt-5" ${cfg.model==='gpt-5'?'selected':''}>gpt-5</option>
            <option value="gpt-5-mini" ${cfg.model==='gpt-5-mini'?'selected':''}>gpt-5-mini</option>
            <option value="gpt-5-nano" ${cfg.model==='gpt-5-nano'?'selected':''}>gpt-5-nano</option>
            <option value="gpt-4-turbo-preview">gpt-4-turbo-preview</option>
            <option value="gpt-4">gpt-4</option>
            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
          </select>
        </div>
        <div>
          <label>Reasoning Effort</label>
          <select id="reasoning-${index}">
            <option value="minimal" ${cfg.reasoning==='minimal'?'selected':''}>minimal</option>
            <option value="low" ${cfg.reasoning==='low'?'selected':''}>low</option>
            <option value="medium" ${cfg.reasoning==='medium'?'selected':''}>medium</option>
            <option value="high" ${cfg.reasoning==='high'?'selected':''}>high</option>
          </select>
        </div>
        <div>
          <label>Verbosity</label>
          <select id="verbosity-${index}">
            <option value="low" ${cfg.verbosity==='low'?'selected':''}>low</option>
            <option value="medium" ${cfg.verbosity==='medium'?'selected':''}>medium</option>
            <option value="high" ${cfg.verbosity==='high'?'selected':''}>high</option>
          </select>
        </div>
        <div>
          <label>Max tokens</label>
          <input type="number" id="maxtok-${index}" min="1" step="1" value="${cfg.maxtok}" />
        </div>
      </div>

      <div class="controls-row sp6">
        <div class="sp3">
          <label>Role</label>
          <input type="text" id="role-${index}" placeholder="I am a therapist / researcher / friend‚Ä¶" value="${escapeHtml(cfg.role)}" />
        </div>
        <div class="sp3">
          <label>Task</label>
          <input type="text" id="task-${index}" placeholder="What should this bot do?" value="${escapeHtml(cfg.task)}" />
        </div>
        <div class="sp6">
          <label>Style</label>
          <textarea id="style-${index}" style="min-height:60px">${escapeHtml(cfg.style||'')}</textarea>
        </div>
      </div>

      <div class="controls-row sp6">
        <div class="sp6 files-panel">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="useGlobal-${index}" ${cfg.useGlobalFiles?'checked':''} />
              Use Global Files
            </label>
            <input type="file" id="botFileInput-${index}" multiple />
            <button class="link-btn" onclick="uploadBotFiles(${index})">Upload to this bot</button>
          </div>
          <div id="botFilesList-${index}" style="margin-top:8px"></div>
          <div style="margin-top:10px">
            <label class="sr-only" for="fileInst-${index}">File Instructions</label>
            <textarea id="fileInst-${index}" placeholder="How should this bot use its files? (Imitate style? Keep facts in mind? Cite strictly?)" style="min-height:60px">${escapeHtml(cfg.fileInstructions||'')}</textarea>
          </div>
        </div>
      </div>

      <div class="controls-row sp6" style="align-items:center">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="autoContinue-${index}" ${cfg.autoContinue?'checked':''} />
          Auto-continue (+${CONTINUE_TOKENS} tokens cycles)
        </label>
      </div>

      <div class="output-content" id="content-${index}">Ready to generate...</div>
    `;
    // Wire inputs ‚Üí state + persist
    ['name','model','reasoning','verbosity','maxtok','role','task','style','fileInst','useGlobal','autoContinue'].forEach(k=>{
      const el = card.querySelector(getIdSel(k,index));
      if(!el) return;
      const evt = (el.tagName==='INPUT' && el.type==='checkbox') ? 'change' : (el.tagName==='INPUT'?'input':'input');
      el.addEventListener(evt, ()=> saveBotField(index,k, el));
    });

    renderBotFiles(index);
    return card;
  }

  function getIdSel(k,i){
    const map = {
      name: `#name-${i}`,
      model: `#model-${i}`,
      reasoning: `#reasoning-${i}`,
      verbosity: `#verbosity-${i}`,
      maxtok: `#maxtok-${i}`,
      role: `#role-${i}`,
      task: `#task-${i}`,
      style: `#style-${i}`,
      fileInst: `#fileInst-${i}`,
      useGlobal: `#useGlobal-${i}`,
      autoContinue: `#autoContinue-${i}`
    };
    return map[k];
  }

  function saveBotField(i,k,el){
    const b = bots[i];
    if (k==='useGlobal') b.useGlobalFiles = !!el.checked;
    else if (k==='autoContinue') b.autoContinue = !!el.checked;
    else if (k==='maxtok') b.maxtok = parseInt(el.value,10)||30;
    else b[{name:'name',model:'model',reasoning:'reasoning',verbosity:'verbosity',role:'role',task:'task',style:'style',fileInst:'fileInstructions'}[k]] = el.value;
    LS.set(BOT_KEY(i), b);
  }

  // Per-bot files
  async function uploadBotFiles(i){
    const input = document.getElementById(`botFileInput-${i}`);
    if(!input.files || !input.files.length) return;
    for (const file of input.files){
      if(!/^text\/|markdown/.test(file.type) && !file.name.endsWith('.txt') && !file.name.endsWith('.md')){
        showError(`Unsupported type: ${file.name}`); continue;
      }
      if (file.size > 500*1024) { showError(`Too large: ${file.name}`); continue; }
      const key = await uploadToR2(file);
      if (key){ bots[i].botFiles.push(key); LS.set(BOT_KEY(i), bots[i]); }
    }
    input.value=''; renderBotFiles(i);
  }

  function renderBotFiles(i){
    const list = document.getElementById(`botFilesList-${i}`);
    const files = bots[i].botFiles||[];
    list.innerHTML = '';
    if (!files.length){ list.innerHTML = '<small>No bot-specific files yet.</small>'; return; }
    files.forEach((key, idx)=>{
      const row = document.createElement('div');
      row.className='file-row';
      const name = key.split('/').pop();
      row.innerHTML = `<div><strong>${name}</strong><span class="badge">bot</span><br><small>${key}</small></div>
        <div>
          <button class="link-btn" onclick="previewFile('${encodeURIComponent(key)}')">Preview</button>
          <button class="link-btn" onclick="removeBotFile(${i},${idx})">Remove</button>
        </div>`;
      list.appendChild(row);
    });
  }
  function removeBotFile(i, idx){
    bots[i].botFiles.splice(idx,1); LS.set(BOT_KEY(i), bots[i]); renderBotFiles(i);
  }

  // -------- Generation flow (no hard-coded ‚Äúcontinue‚Äù instructions) --------
  async function generateOutputs(){
    if (!apiKey){ showError('Please configure your API key first'); openApiKeyModal(); return; }
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt){ showError('Enter a prompt'); return; }

    // Stop any pending timers
    try{ continuationTimers.forEach((t,ix)=>{ if(t){ clearTimeout(t); continuationTimers[ix]=null; } }); }catch(_){}

    // Show loading states
    for (let i=0;i<9;i++){
      const div = document.getElementById(`content-${i}`);
      if (div){ div.textContent='Generating‚Ä¶'; div.classList.remove('error','success'); }
    }

    await Promise.all(bots.map((_,i)=> generateSingleOutput(i, apiKey, prompt)));
  }

  async function generateSingleOutput(i, apiKey, userPrompt){
    const b = bots[i];
    const contentDiv = document.getElementById(`content-${i}`);

    try{
      // Build inputs entirely from editable fields
      const systemParts = [];
      if (b.role) systemParts.push(`ROLE: ${b.role}`);
      if (b.style) systemParts.push(`STYLE: ${b.style}`);
      if (b.fileInstructions) systemParts.push(`FILE INSTRUCTIONS: ${b.fileInstructions}`);
      if (b.useGlobalFiles && globalFileInstructions) systemParts.push(`GLOBAL FILE INSTRUCTIONS: ${globalFileInstructions}`);
      const systemMessage = systemParts.join('\n');

      const taskLine = b.task ? `TASK: ${b.task}` : '';
      const mainUser = [taskLine, `PROMPT:\n${userPrompt}`].filter(Boolean).join('\n\n');

      // Load file contents (text/markdown)
      const allKeys = [
        ...(b.useGlobalFiles ? globalFiles : []),
        ...(b.botFiles||[])
      ];
      const filesText = await loadFilesText(allKeys, 8000); // ~8k chars cap
      const filesChunk = filesText.length ? `\n\n=== FILES CONTEXT START ===\n${filesText}\n=== FILES CONTEXT END ===` : '';

      const model = b.model;
      const maxtok = parseInt(b.maxtok,10) || undefined;
      const bodyForGpt5 = {
        model,
        input: [systemMessage, mainUser, filesChunk].filter(Boolean).join('\n\n'),
        reasoning: { effort: b.reasoning },
        text: { verbosity: b.verbosity }
      };
      if (maxtok) bodyForGpt5.max_output_tokens = maxtok;

      // Call appropriate API
      let outText = '';
      if (model.startsWith('gpt-5')){
        const r = await fetch('https://api.openai.com/v1/responses', {
          method:'POST',
          headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},
          body: JSON.stringify(bodyForGpt5)
        });
        const raw = await r.text(); let data; try{ data=JSON.parse(raw);}catch{ data={output_text: raw}; }
        if (!r.ok) throw new Error((data && data.error && data.error.message) || `HTTP ${r.status}`);
        outText = extractTextFromResponse(data) || '';
      } else {
        const chatBody = {
          model,
          messages: [
            {role:'system', content: systemMessage || 'You are a helpful assistant.'},
            {role:'user', content: [mainUser, filesChunk].filter(Boolean).join('\n\n')}
          ]
        };
        if (maxtok) chatBody.max_tokens = maxtok;
        const r = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST',
          headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},
          body: JSON.stringify(chatBody)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
        outText = data?.choices?.[0]?.message?.content || '';
      }

      outputs[i] = outText;
      contentDiv.textContent = outText || '(no output)';
      contentDiv.classList.add('success');

      lastPrompts[i] = userPrompt;
      if (b.autoContinue){ scheduleNextContinuation(i, apiKey, userPrompt); }
    }catch(err){
      contentDiv.textContent = `Error: ${err?.message || String(err)}`;
      contentDiv.classList.add('error');
    }
  }

  // Simple continuation loop (only if autoContinue is ON)
  function scheduleNextContinuation(i, apiKey, basePrompt){
    if (continuationTimers[i]) clearTimeout(continuationTimers[i]);
    continuationTimers[i] = setTimeout(()=> generateContinuation(i, apiKey, basePrompt), 5000);
  }
  async function generateContinuation(i, apiKey, basePrompt){
    if (!bots[i].autoContinue) return;
    // Re-use all same parameters, but ask for a small follow-up (+CONTINUE_TOKENS)
    const b = bots[i];
    const contentDiv = document.getElementById(`content-${i}`);
    try{
      let text = '';
      if (b.model.startsWith('gpt-5')){
        const body = {
          model: b.model,
          input: `Continue (briefly) based on the previous answer:\n\n${outputs[i]}\n\nNEXT:`,
          reasoning: { effort: b.reasoning },
          text: { verbosity: b.verbosity },
          max_output_tokens: CONTINUE_TOKENS
        };
        const r = await fetch('https://api.openai.com/v1/responses', {
          method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const raw = await r.text(); let data; try{ data=JSON.parse(raw);}catch{ data={output_text: raw}; }
        if (!r.ok) throw new Error((data && data.error && data.error.message) || `HTTP ${r.status}`);
        text = extractTextFromResponse(data)||'';
      } else {
        const chatBody = {
          model: b.model,
          messages: [{role:'user', content:`Continue (briefly) based on the previous answer:\n\n${outputs[i]}\n\nNEXT:`}],
          max_tokens: CONTINUE_TOKENS
        };
        const r = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},
          body: JSON.stringify(chatBody)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
        text = data?.choices?.[0]?.message?.content || '';
      }
      outputs[i] = (outputs[i] ? outputs[i] + ' ' : '') + text;
      contentDiv.textContent = outputs[i];
      scheduleNextContinuation(i, apiKey, basePrompt);
    }catch(e){
      contentDiv.textContent = 'Continuation error: ' + (e?.message||String(e));
      contentDiv.classList.add('error');
    }
  }

  // -------- Helpers --------
  async function loadFilesText(keys, totalCapChars){
    if (!keys || !keys.length) return '';
    const chunks = [];
    let budget = totalCapChars||8000;
    for (const key of keys){
      try{
        const r = await fetch('/api/file-url?key='+encodeURIComponent(key));
        const j = await r.json();
        const resp = await fetch(j.url);
        const ct = resp.headers.get('content-type')||'';
        if (!/text|markdown|plain|utf-8/i.test(ct)) continue;
        const txt = (await resp.text())||'';
        const take = txt.slice(0, Math.max(0,budget));
        if (take){
          const name = key.split('/').pop();
          chunks.push(`FILE: ${name}\n${take}`);
          budget -= take.length;
          if (budget <= 0) break;
        }
      }catch(_){}
    }
    return chunks.join('\n\n');
  }

  function extractTextFromResponse(responseData){
    try{
      if (!responseData) return '';
      if (responseData.output_text) return responseData.output_text;
      if (responseData.completion) return responseData.completion;
      if (Array.isArray(responseData.output)){
        const msg = responseData.output.find(x=>x.type==='message');
        if (msg && Array.isArray(msg.content)){
          const t = msg.content.find(x=>x.type==='output_text');
          if (t && t.text) return t.text;
          return msg.content.map(x=>x.text||x.message||'').join('\n');
        }
      }
      if (Array.isArray(responseData.choices)){
        return responseData.choices[0]?.message?.content || responseData.choices[0]?.text || '';
      }
    }catch(_){}
    return '';
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Debug toggle (minimal)
  function toggleDebug(){ debugMode = !debugMode; toast(debugMode? 'Debug on':'Debug off'); }
  </script>
  <!-- ===================== END BLOCK I: SCRIPT ===================================== -->
</body>
</html>
