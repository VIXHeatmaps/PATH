<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===================== BEGIN BLOCK A: LOGIN GATE (Discord) ===================== -->
  <style id="login-gate-style">html{visibility:hidden}</style>
  <script>
  (async () => {
    try {
      // Any protected endpoint works; we use upload-url because it already checks the session.
      const resp = await fetch('/api/upload-url', { credentials: 'include' });
      if (resp.status === 401) { location.href = '/api/auth/discord/start'; return; }
    } catch (e) { /* if it fails for network reasons, still reveal for debugging */ }
    document.documentElement.style.visibility = 'visible';
  })();
  </script>
  <!-- ===================== END BLOCK A: LOGIN GATE (Discord) ======================= -->

  <!-- ===================== BEGIN BLOCK B: BASE PAGE METADATA ======================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PATH v0.25 ‚Äì Parallel Adaptive Text Helper</title>
  <!-- ===================== END BLOCK B: BASE PAGE METADATA ========================= -->

  <!-- ===================== BEGIN BLOCK C: STYLES =================================== -->
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1600px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:20px}
    .title-section{display:flex;align-items:baseline;gap:10px}
    h1{color:#667eea;font-size:1.2em;font-weight:600;margin:0}
    .subtitle{color:#999;font-size:.85em;font-weight:300}
    .version{color:#bbb;font-size:.75em;font-family:monospace}
    .top-actions{display:flex;align-items:center;gap:10px}
    .link-btn{background:none;border:none;color:#777;font-size:.85em;cursor:pointer;padding:6px 10px;border-radius:8px}
    .link-btn:hover{color:#333;background:#f3f3f3}
    .link-btn.configured{color:#2e7d32}
    textarea::placeholder{color:#9aa0a6}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .input-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:25px}
    .input-group{margin-bottom:14px}
    label{display:block;margin-bottom:8px;color:#555;font-weight:600}
    textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;resize:vertical;min-height:120px;transition:border-color .3s}
    textarea:focus{outline:none;border-color:#667eea}
    .generate-section{display:flex;gap:15px;align-items:center;margin-top:10px}
    .generate-btn{padding:12px 40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s}
    .generate-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
    .api-key-btn{padding:10px 14px;background:#f0f0f0;color:#333;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:background .2s}
    .api-key-btn:hover{background:#e0e0e0}
    .api-key-btn.configured{background:#e8f5e9;color:#2e7d32}

    .outputs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:20px;margin-top:20px}
    .output-card{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:20px;position:relative;transition:transform .2s,box-shadow .2s,border-color .2s}
    .output-card:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .num-badge{position:absolute;top:10px;left:12px;font-size:12px;color:#9aa2b1;font-weight:600;user-select:none;pointer-events:none;}
    .output-content{background:#f8f9fa;padding:15px;border-radius:8px;min-height:150px;max-height:320px;overflow-y:auto;white-space:pre-wrap;font-family:Monaco,Menlo,Consolas,monospace;font-size:14px;line-height:1.5;cursor:pointer;transition:background .2s,transform .2s;position:relative}
    .output-content:hover{background:#eef6ff}
    .output-content.clicked{animation:clickPulse .5s}
    @keyframes clickPulse{0%{background:#eef6ff}50%{background:#dbeafe}100%{background:#eef6ff}}
    .output-content.error{background:#ffebee;color:#c62828}
    .output-content.success{background:#f0fff4}

    .refresh-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;background:rgba(255,255,255,.9);border:1px solid #ddd;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:10;font-size:14px}
    .refresh-btn:hover{background:#667eea;color:#fff;border-color:#667eea;transform:rotate(180deg)}
    .refresh-btn.spinning{animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .vars-bar{margin-top:10px;font-size:12px;color:#555;display:flex;align-items:center;gap:8px;cursor:pointer}
    .vars-bar .chev{transition:transform .2s;display:inline-block}
    .vars-bar.open .chev{transform:rotate(90deg)}
    .output-settings.collapsed{display:none}
    .settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .setting-group{display:flex;flex-direction:column;gap:6px}
    .setting-label{font-size:11px;color:#666}
    .output-settings select,.output-settings input{padding:8px;border:1px solid #ddd;border-radius:8px;font-size:12px;background:#fff}
    .output-settings textarea{min-height:56px;font-size:12px;padding:8px;border:1px solid #ddd;border-radius:8px}
    .style-input{grid-column:1/-1}

    .error-message{color:#d32f2f;padding:10px;background:#ffebee;border-radius:8px;margin-top:10px;display:none}
    .error-message.active{display:block}

    .debug-panel{display:none;background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;font-size:12px;font-family:monospace;max-height:200px;overflow-y:auto}
    .debug-panel.active{display:block}

    .toast{position:fixed;bottom:30px;right:30px;background:#4CAF50;color:#fff;padding:15px 20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:all .3s;z-index:1001}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
  <!-- ===================== END BLOCK C: STYLES ===================================== -->
</head>
<body>
  <!-- ===================== BEGIN BLOCK D: PAGE HEADER + TOP ACTIONS ================= -->
  <div class="container">
    <div class="header">
      <div class="title-section">
        <h1>PATH</h1>
        <span class="subtitle">Parallel Adaptive Text Helper</span>
      </div>
      <div class="top-actions">
        <button class="link-btn" id="apiKeyBtn" onclick="openApiKeyModal()" title="API Key">üîê API</button>
        <button class="link-btn" onclick="toggleDebug()" title="Debug panel">üõ† Debug</button>
        <span class="version">v0.25_visible_instructions</span>
      </div>
    </div>
  <!-- ===================== END BLOCK D: PAGE HEADER + TOP ACTIONS =================== -->

  <!-- ===================== BEGIN BLOCK E: DEBUG PANEL ============================== -->
    <div class="debug-panel" id="debugPanel"></div>
  <!-- ===================== END BLOCK E: DEBUG PANEL ================================ -->

  <!-- ===================== BEGIN BLOCK F: INPUT SECTION ============================ -->
    <div class="input-section">
      <div class="input-group">
        <label for="prompt" class="sr-only">Enter text</label>
        <textarea id="prompt" placeholder="Enter your message‚Ä¶&#10;Press Enter or click Run all"></textarea>
      </div>

      <!-- Global knowledge files (applies to every bot) -->
      <div style="margin-top:10px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;">
        <div style="font-weight:600; color:#444; margin-bottom:8px;">Global Knowledge Files</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="globalFileInput" type="file" multiple />
          <button class="api-key-btn" id="uploadGlobalBtn" type="button">Upload to Global</button>
        </div>
        <div id="globalFilesList" style="margin-top:8px; font-size:12px; color:#444;"></div>
        <div style="margin-top:6px; font-size:11px; color:#777;">
          Tip: upload small <code>.txt</code>/<code>.md</code> files. They‚Äôre stored in R2 and listed here. Remove to stop including.
        </div>
      </div>

      <div class="generate-section">
        <button class="generate-btn" id="runAllBtn" onclick="generateOutputs()">Run all (Enter)</button>
        <span id="loadingSpinner"></span>
      </div>

      <div class="error-message" id="errorMessage"></div>
    </div>
  <!-- ===================== END BLOCK F: INPUT SECTION ============================== -->

  <!-- ===================== BEGIN BLOCK G: OUTPUTS GRID ============================= -->
    <div class="outputs-grid" id="outputsGrid"></div>
  </div>
  <!-- ===================== END BLOCK G: OUTPUTS GRID =============================== -->

  <!-- ===================== BEGIN BLOCK H: API KEY MODAL ============================ -->
  <div id="apiKeyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-close" onclick="closeApiKeyModal()">&times;</span>
        <h2 class="modal-title">OpenAI API Key</h2>
        <p style="color:#666;font-size:14px;margin-top:5px;">Stored locally in your browser and only sent to OpenAI.</p>
      </div>
      <div class="modal-body">
        <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-..." />
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="saveApiKey()">Save</button>
      </div>
    </div>
  </div>
  <!-- ===================== END BLOCK H: API KEY MODAL ============================== -->

  <!-- ===================== BEGIN BLOCK I: TOAST ==================================== -->
  <div id="toast" class="toast">Text appended to prompt!</div>
  <!-- ===================== END BLOCK I: TOAST ====================================== -->

  <!-- ===================== BEGIN BLOCK J: MAIN SCRIPT ============================== -->
  <script>
    /* ========= State ========= */
    let outputs = Array(9).fill('');
    let debugMode = false;
    let apiKey = localStorage.getItem('path_api_key') || '';

    /* ========= Default configs with visible instructions ========= */
    const defaultConfigs = Array.from({length:9}, (_,i)=>({
      name: `Bot ${i+1}`,
      model: i===3 || i===8 ? 'gpt-5-mini' : (i===6 ? 'gpt-5-nano' : 'gpt-5'),
      role: '',
      task: '',
      style: [
        'Write in a concise, narrative style',
        'Write in an analytical, essay-like style',
        'Write in a punchy, engaging copywriting style',
        'Write in plain, accessible English',
        'Write in a technical, precise style',
        'Write in a thoughtful, storytelling style',
        'Write in a casual, conversational blog style',
        'Write in a journalistic, news-reporting style',
        'Write in a poetic, lyrical style'
      ][i] || '',
      fileinst: 'Use files as background context; quote or imitate only when explicitly asked.'
    }));

    /* ========= Utilities ========= */
    function addDebugLog(msg){ if(!debugMode) return;
      const p=document.getElementById('debugPanel');
      const ts=new Date().toISOString().substr(11,8);
      p.innerHTML+=`[${ts}] ${msg}\n`;
      p.scrollTop=p.scrollHeight;
    }
    function showError(message){
      const el=document.getElementById('errorMessage');
      el.textContent=message; el.classList.add('active');
      setTimeout(()=>el.classList.remove('active'), 5000);
    }
    function showToast(message){
      const t=document.getElementById('toast'); t.textContent=message; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000);
    }

    function getModelDefaults(model){
      const m=(model||'').toLowerCase();
      return m.startsWith('gpt-5') ? { reasoning:'minimal', verbosity:'low', maxtok:30 }
                                   : { reasoning:'medium',  verbosity:'medium', maxtok:30 };
    }

    /* ========= Persistence ========= */
    const VAR_KEYS = ['name','model','reasoning','verbosity','style','maxtok','role','task','fileinst'];
    function cardKey(i,k){ return `path_card_${i}_${k}`; }
    function filesKeyGlobal(){ return `path_global_files`; }
    function filesKeyForBot(i){ return `path_card_${i}_files`; }

    function loadCardSettings(index){
      try{
        VAR_KEYS.forEach(k=>{
          const el = document.getElementById(`${k}-${index}`);
          if (!el) return;
          const saved = localStorage.getItem(cardKey(index,k));
          if (saved !== null) el.value = saved;
        });
        renderFileList(document.getElementById(`botFilesList-${index}`), loadFilesForBot(index), 'bot', index);
        updateVarSummary(index);
      }catch(e){ addDebugLog(`Settings load error [${index}]: ${e}`); }
    }
    function handleSettingEvent(e){
      const t=e && e.target; if(!t||!t.id) return;
      const m=t.id.match(/^(name|model|reasoning|verbosity|style|maxtok|role|task|fileinst)-(\d+)$/);
      if(!m) return;
      const idx = parseInt(m[2],10);
      localStorage.setItem(cardKey(idx, m[1]), t.value);
      if (m[1]==='model') applyModelDefaults(idx, t.value, true);
      updateVarSummary(idx);
    }
    document.addEventListener('change', handleSettingEvent);
    document.addEventListener('input',  handleSettingEvent);

    /* ========= Files state (localStorage lists; data in R2) ========= */
    function loadGlobalFiles(){ try { return JSON.parse(localStorage.getItem(filesKeyGlobal())||'[]'); } catch{ return []; } }
    function saveGlobalFiles(list){ localStorage.setItem(filesKeyGlobal(), JSON.stringify(list)); }
    function loadFilesForBot(i){ try { return JSON.parse(localStorage.getItem(filesKeyForBot(i))||'[]'); } catch{ return []; } }
    function saveFilesForBot(i, list){ localStorage.setItem(filesKeyForBot(i), JSON.stringify(list)); }

    async function uploadToR2(file){
      const res = await fetch('/api/upload-url', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ filename: file.name, contentType: file.type || 'text/plain' })
      });
      if(!res.ok){ throw new Error('Failed to get signed upload URL'); }
      const { url, key } = await res.json();
      const put = await fetch(url, { method:'PUT', headers:{'Content-Type': file.type||'text/plain'}, body:file });
      if(!put.ok){ throw new Error('PUT to storage failed'); }
      return { key, name:file.name, size:file.size };
    }

    async function fetchFileTextByKey(key){
      const res = await fetch('/api/file-url?key=' + encodeURIComponent(key), { credentials:'include' });
      if(!res.ok) throw new Error('file-url failed');
      const { url } = await res.json();
      const txt = await fetch(url).then(r=>r.text());
      return txt;
    }

    function renderFileList(container, list, scope, index){
      if (!container) return;
      if (!Array.isArray(list) || list.length===0){
        container.innerHTML = `<div style="color:#777">No files.</div>`;
        return;
      }
      container.innerHTML = list.map((f, idx)=>`
        <div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-top:1px dashed #eee;">
          <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            <strong>${f.name}</strong> <span style="color:#999">(${f.size||'?'} bytes)</span>
          </div>
          <button class="link-btn" type="button" data-scope="${scope}" data-index="${index||''}" data-fileidx="${idx}" data-act="preview">Preview</button>
          <button class="link-btn" type="button" data-scope="${scope}" data-index="${index||''}" data-fileidx="${idx}" data-act="remove">Remove</button>
        </div>
      `).join('');
    }
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button.link-btn'); if(!btn) return;
      const act = btn.dataset.act; if(!act) return;
      if (act==='preview'){
        const scope=btn.dataset.scope, i=parseInt(btn.dataset.index||'-1',10), fi=parseInt(btn.dataset.fileidx,10);
        const list = scope==='global' ? loadGlobalFiles() : loadFilesForBot(i);
        const file = list[fi]; if (!file) return;
        try{ const text = await fetchFileTextByKey(file.key); alert((text||'').slice(0,2000)); }
        catch(err){ alert('Preview failed: '+err.message); }
      } else if (act==='remove'){
        const scope=btn.dataset.scope, i=parseInt(btn.dataset.index||'-1',10), fi=parseInt(btn.dataset.fileidx,10);
        const list = scope==='global' ? loadGlobalFiles() : loadFilesForBot(i);
        list.splice(fi,1);
        if (scope==='global'){ saveGlobalFiles(list); renderFileList(document.getElementById('globalFilesList'), list, 'global'); }
        else { saveFilesForBot(i, list); renderFileList(document.getElementById(`botFilesList-${i}`), list, 'bot', i); }
      }
    });

    /* ========= Header buttons / modal ========= */
    function updateApiKeyButton(){
      const btn=document.getElementById('apiKeyBtn');
      if (!btn) return;
      if (apiKey){ btn.classList.add('configured'); btn.textContent='üîê API'; }
      else { btn.classList.remove('configured'); btn.textContent='üîë API'; }
    }
    function openApiKeyModal(){document.getElementById('apiKeyModal').classList.add('active');document.getElementById('apiKeyInput').value=apiKey;}
    function closeApiKeyModal(){document.getElementById('apiKeyModal').classList.remove('active');}
    function saveApiKey(){apiKey=document.getElementById('apiKeyInput').value;localStorage.setItem('path_api_key',apiKey);updateApiKeyButton();showToast('API Key saved!');}
    function toggleDebug(){debugMode=!debugMode;document.getElementById('debugPanel').classList.toggle('active');}

    /* ========= Cards UI ========= */
    function getVarSummary(index){
      const model = document.getElementById(`model-${index}`)?.value || '';
      const r  = document.getElementById(`reasoning-${index}`)?.value || '';
      const v  = document.getElementById(`verbosity-${index}`)?.value || '';
      const cap= document.getElementById(`maxtok-${index}`)?.value || 'auto';
      const name = document.getElementById(`name-${index}`)?.value || `Bot ${index+1}`;
      return `${name} ¬∑ ${model} ¬∑ r:${r} ¬∑ v:${v} ¬∑ cap:${cap}`;
    }
    function updateVarSummary(index){
      const el=document.getElementById(`varssum-${index}`);
      if (el) el.textContent=getVarSummary(index);
    }
    function applyModelDefaults(index, model, fromChange){
      const d=getModelDefaults(model);
      const rSel=document.getElementById(`reasoning-${index}`);
      const vSel=document.getElementById(`verbosity-${index}`);
      const tInp=document.getElementById(`maxtok-${index}`);
      if (rSel) rSel.value=d.reasoning;
      if (vSel) vSel.value=d.verbosity;
      if (tInp) tInp.value=d.maxtok;
      updateVarSummary(index);
      addDebugLog(`Output ${index+1}: Defaults for ${model}`);
    }

    function initializeOutputCards(){
      const grid=document.getElementById('outputsGrid');
      grid.innerHTML='';
      for (let i=0;i<9;i++){
        grid.appendChild(createOutputCard(i));
        const modelSel=document.getElementById(`model-${i}`);
        if(modelSel) applyModelDefaults(i, modelSel.value, false);
        loadCardSettings(i);
      }
    }

    function createOutputCard(index){
      const cfg=defaultConfigs[index];
      const card=document.createElement('div');
      card.className='output-card';
      card.id=`output-${index}`;
      card.innerHTML=`
        <div class="num-badge">${index+1}.</div>
        <button class="refresh-btn" id="refresh-${index}" onclick="refreshOutput(${index})" title="Run this bot">‚Üª</button>
        <div class="output-content" id="content-${index}" onclick="appendOutput(${index})">Ready to generate...</div>

        <div class="vars-bar" id="varsbar-${index}" onclick="toggleVars(${index})">
          <span class="chev">‚ñ∏</span><span id="varssum-${index}"></span>
        </div>

        <div class="output-settings collapsed" id="settings-${index}">
          <div class="settings-grid">

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Bot Name</label>
              <input id="name-${index}" value="${cfg.name}" placeholder="e.g., Researcher, Therapist‚Ä¶" />
            </div>

            <div class="setting-group">
              <label class="setting-label">Model</label>
              <select id="model-${index}">
                <option value="gpt-5" ${cfg.model==='gpt-5'?'selected':''}>gpt-5</option>
                <option value="gpt-5-mini" ${cfg.model==='gpt-5-mini'?'selected':''}>gpt-5-mini</option>
                <option value="gpt-5-nano" ${cfg.model==='gpt-5-nano'?'selected':''}>gpt-5-nano</option>
                <option value="gpt-5-thinking">gpt-5-thinking</option>
                <option value="gpt-5-thinking-mini">gpt-5-thinking-mini</option>
                <option value="gpt-5-thinking-nano">gpt-5-thinking-nano</option>
                <option value="gpt-4-turbo-preview">GPT-4 Turbo (Fallback)</option>
                <option value="gpt-4">GPT-4 (Fallback)</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fallback)</option>
              </select>
            </div>

            <div class="setting-group">
              <label class="setting-label">Reasoning Effort</label>
              <select id="reasoning-${index}">
                <option value="minimal">minimal</option>
                <option value="low">low</option>
                <option value="medium">medium</option>
                <option value="high">high</option>
              </select>
            </div>

            <div class="setting-group">
              <label class="setting-label">Verbosity</label>
              <select id="verbosity-${index}">
                <option value="low">low</option>
                <option value="medium">medium</option>
                <option value="high">high</option>
              </select>
            </div>

            <div class="setting-group">
              <label class="setting-label">Max tokens (hard cap)</label>
              <input type="number" id="maxtok-${index}" min="1" step="1" value="30" placeholder="e.g., 80" />
            </div>

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Role</label>
              <textarea id="role-${index}" placeholder="I am a therapist / researcher / friend‚Ä¶">${cfg.role}</textarea>
            </div>

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Task</label>
              <textarea id="task-${index}" placeholder="Describe exactly what this bot should do‚Ä¶">${cfg.task}</textarea>
            </div>

            <div class="setting-group style-input" style="grid-column:1/-1">
              <label class="setting-label">Style</label>
              <textarea id="style-${index}" placeholder="How should it write/behave?">${cfg.style}</textarea>
            </div>

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">File Instructions</label>
              <textarea id="fileinst-${index}" placeholder="How to use the files (imitate style, keep in mind, quote cautiously‚Ä¶)">${cfg.fileinst}</textarea>
            </div>

            <!-- Per-bot files -->
            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Bot Files</label>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input id="botFileInput-${index}" type="file" multiple />
                <button type="button" class="api-key-btn" id="uploadBotBtn-${index}">Upload to this bot</button>
              </div>
              <div id="botFilesList-${index}" style="margin-top:8px; font-size:12px;"></div>
            </div>

          </div>
        </div>`;
      // wire uploads
      card.querySelector(`#uploadBotBtn-${index}`).addEventListener('click', async ()=>{
        const inp=card.querySelector(`#botFileInput-${index}`); if(!inp||!inp.files||!inp.files.length) return;
        const current=loadFilesForBot(index);
        for(const f of inp.files){ try{ const meta=await uploadToR2(f); current.push(meta); }
          catch(e){ showError('Bot file upload failed: '+e.message); } }
        saveFilesForBot(index,current);
        renderFileList(card.querySelector(`#botFilesList-${index}`), current, 'bot', index);
        inp.value='';
      });
      // model change for defaults
      card.querySelector(`#model-${index}`).addEventListener('change', (e)=>{ applyModelDefaults(index, e.target.value, true); });
      return card;
    }

    function toggleVars(index){
      const s=document.getElementById(`settings-${index}`);
      const b=document.getElementById(`varsbar-${index}`);
      if (!s||!b) return;
      if (s.classList.contains('collapsed')){ s.classList.remove('collapsed'); b.classList.add('open'); }
      else { s.classList.add('collapsed'); b.classList.remove('open'); }
    }

    /* ========= Build context from files ========= */
    async function buildContextText(index){
      const globalFiles = loadGlobalFiles();
      const botFiles = loadFilesForBot(index);
      const all = [...globalFiles, ...botFiles];
      if (all.length===0) return '';
      let total = 0, parts = [];
      for(const f of all){
        try{
          let t = await fetchFileTextByKey(f.key);
          if (!t) continue;
          t = t.slice(0, 4000); // limit per file
          total += t.length; if (total > 8000) break;
          parts.push(`--- BEGIN FILE: ${f.name}\n${t}\n--- END FILE: ${f.name}`);
        }catch(e){}
      }
      return parts.join('\n\n');
    }

    function extractTextFromResponse(data){
      try{
        if (data?.output_text) return data.output_text;
        if (Array.isArray(data?.output)){
          const msg = data.output.find(x=>x.type==='message');
          if (msg?.content?.length){
            const t = msg.content.find(x=>x.type==='output_text');
            if (t?.text) return t.text;
            return msg.content.map(c=>c.text||c.content||'').join('\n');
          }
        }
        if (Array.isArray(data?.choices)){
          return data.choices[0]?.message?.content || data.choices[0]?.text || '';
        }
      }catch{}
      return '';
    }

    /* ========= Run one bot ========= */
    async function refreshOutput(index){
      if (!apiKey){ showError('Please save your API key first'); openApiKeyModal(); return; }
      const prompt=document.getElementById('prompt').value || '';
      const name = document.getElementById(`name-${index}`).value || `Bot ${index+1}`;
      const model= document.getElementById(`model-${index}`).value;
      const reason=document.getElementById(`reasoning-${index}`).value;
      const verb  = document.getElementById(`verbosity-${index}`).value;
      const style = document.getElementById(`style-${index}`).value;
      const role  = document.getElementById(`role-${index}`).value;
      const task  = document.getElementById(`task-${index}`).value;
      const filei = document.getElementById(`fileinst-${index}`).value;
      let maxTok  = parseInt(document.getElementById(`maxtok-${index}`)?.value,10);
      if (!(maxTok>0)) maxTok=null;

      const btn=document.getElementById(`refresh-${index}`);
      const out=document.getElementById(`content-${index}`);
      btn.classList.add('spinning'); out.classList.remove('error','success'); out.textContent=`${name} is thinking‚Ä¶`;

      try{
        const filesContext = await buildContextText(index);

        // Build the visible, editable instruction
        let sys = '';
        if (role) sys += `You are ${role}. `;
        if (task) sys += `Your task: ${task}. `;
        if (style) sys += `Style guidance: ${style}. `;
        if (filesContext){
          sys += `You have reference material. File instructions: ${filei||'Use as background context only.'}\n\n${filesContext}`;
        }
        const userMsg = prompt ? `User input:\n${prompt}` : 'No additional user input was provided.';

        // Choose API
        let textOut='';
        if (model.startsWith('gpt-5')){
          const body = { model, input: `${sys}\n\n${userMsg}`, reasoning:{effort:reason}, text:{verbosity:verb} };
          if (maxTok) body.max_output_tokens = maxTok;
          const r = await fetch('https://api.openai.com/v1/responses', {
            method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'}, body: JSON.stringify(body)
          });
          const raw = await r.text(); let data; try{ data=JSON.parse(raw);}catch{ data={output_text:raw}; }
          if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
          textOut = (extractTextFromResponse(data)||'').trim();
        } else {
          const body = {
            model,
            messages: [
              { role:'system', content: sys || 'You are a helpful assistant.' },
              { role:'user',   content: userMsg }
            ]
          };
          if (maxTok) body.max_tokens = maxTok;
          const r = await fetch('https://api.openai.com/v1/chat/completions', {
            method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'}, body: JSON.stringify(body)
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
          textOut = (data?.choices?.[0]?.message?.content||'').trim();
        }

        outputs[index]=textOut || 'No output';
        out.textContent=outputs[index]; out.classList.add('success');
      }catch(err){
        out.textContent = `Error: ${err.message||String(err)}`; out.classList.add('error');
      }finally{
        btn.classList.remove('spinning');
      }
    }

    /* ========= Run all ========= */
    async function generateOutputs(){
      if (!apiKey){ showError('Please save your API key first'); openApiKeyModal(); return; }
      const prompt=document.getElementById('prompt').value;
      if (!prompt){ showError('Please enter text'); return; }

      const ls=document.getElementById('loadingSpinner'); if (ls) ls.innerHTML='<span class="loading"></span>';
      const promises=[];
      for (let i=0;i<9;i++){
        document.getElementById(`content-${i}`).textContent='Generating‚Ä¶';
        promises.push(refreshOutput(i));
      }
      await Promise.all(promises);
      if (ls) ls.innerHTML='';
    }

    function appendOutput(index){
      if (!outputs[index]) return;
      const prompt=document.getElementById('prompt');
      const sep = prompt.value.trim() ? ' // ' : '';
      prompt.value += sep + outputs[index];
      prompt.scrollTop=prompt.scrollHeight;
      const el=document.getElementById(`content-${index}`); el.classList.add('clicked'); setTimeout(()=>el.classList.remove('clicked'),500);
      showToast('Text appended to prompt!');
    }

    /* ========= Global files uploader wiring ========= */
    window.addEventListener('DOMContentLoaded', ()=>{
      initializeOutputCards();
      updateApiKeyButton();

      // Restore global files list & wire upload
      renderFileList(document.getElementById('globalFilesList'), loadGlobalFiles(), 'global');
      const gBtn = document.getElementById('uploadGlobalBtn');
      const gInp = document.getElementById('globalFileInput');
      if (gBtn && gInp){
        gBtn.addEventListener('click', async ()=>{
          if (!gInp.files || !gInp.files.length) return;
          const cur = loadGlobalFiles();
          for(const f of gInp.files){ try{ const meta=await uploadToR2(f); cur.push(meta); }
            catch(e){ showError('Global upload failed: '+e.message); } }
          saveGlobalFiles(cur);
          renderFileList(document.getElementById('globalFilesList'), cur, 'global');
          gInp.value='';
        });
      }

      // Enter to run all
      const ta = document.getElementById('prompt');
      if (ta){
        ta.addEventListener('keydown', (e)=>{
          if (e.key==='Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey){
            e.preventDefault(); generateOutputs();
          }
        });
      }
    });

    // Hotkeys 1..9 append
    document.addEventListener('keydown', (e)=>{
      const ae=document.activeElement; const tag=(ae && ae.tagName||'').toLowerCase();
      const isOtherInput = (tag==='input') || (tag==='textarea' && ae.id!=='prompt') || (ae && ae.isContentEditable);
      if (isOtherInput || e.ctrlKey||e.metaKey||e.altKey) return;
      const k=e.key; if (k>='1'&&k<='9'){ e.preventDefault(); appendOutput(parseInt(k,10)-1); }
    });
  </script>
  <!-- ===================== END BLOCK J: MAIN SCRIPT ================================ -->
</body>
</html>
