<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===================== BEGIN BLOCK A: LOGIN GATE (Discord) ===================== -->
  <style id="login-gate-style">html{visibility:hidden}</style>
  <script>
  (async () => {
    try {
      const resp = await fetch('/api/upload-url', { credentials: 'include' });
      if (resp.status === 401) { location.href = '/api/auth/discord/start'; return; }
    } catch(e) {}
    document.documentElement.style.visibility = 'visible';
  })();
  </script>
  <!-- ===================== END BLOCK A: LOGIN GATE (Discord) ======================= -->

  <!-- ===================== BEGIN BLOCK B: META ===================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PATH v0.25 ‚Äì Parallel Adaptive Text Helper</title>
  <!-- ===================== END BLOCK B: META ======================================= -->

  <!-- ===================== BEGIN BLOCK C: STYLES =================================== -->
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1600px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .title-section{display:flex;align-items:baseline;gap:10px}
    h1{color:#667eea;font-size:1.2em;font-weight:600;margin:0}
    .subtitle{color:#999;font-size:.85em;font-weight:300}
    .version{color:#bbb;font-size:.75em;font-family:monospace}
    .top-actions{display:flex;align-items:center;gap:8px}
    .link-btn{background:#fff;border:1px solid #e5e7eb;color:#444;font-size:.8em;cursor:pointer;padding:6px 10px;border-radius:8px}
    .link-btn:hover{background:#f7f7f7}
    .link-btn.configured{border-color:#cfe9d6;color:#2e7d32;background:#f3fbf5}
    .badge{font-size:.75em;color:#bbb;margin-left:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .input-section{background:#f8f9fa;padding:16px;border-radius:12px;margin-bottom:18px}
    .input-group{margin-bottom:10px}
    textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;resize:vertical;min-height:110px;transition:border-color .2s}
    textarea:focus{outline:none;border-color:#667eea}
    .error-message{color:#d32f2f;padding:10px;background:#ffebee;border-radius:6px;margin-top:10px;display:none}
    .error-message.active{display:block}

    .outputs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:18px;margin-top:16px}
    .output-card{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:16px;position:relative;transition:transform .2s,box-shadow .2s,border-color .2s}
    .output-card:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .num-badge{position:absolute;top:8px;left:10px;font-size:12px;color:#9aa2b1;font-weight:600;user-select:none;pointer-events:none;}
    .refresh-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;background:rgba(255,255,255,.95);border:1px solid #ddd;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:2;font-size:14px}
    .refresh-btn:hover{background:#667eea;color:#fff;border-color:#667eea}
    .refresh-btn.spinning{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .output-content{background:#f8f9fa;padding:12px;border-radius:8px;min-height:140px;max-height:300px;overflow-y:auto;white-space:pre-wrap;font-family:Menlo,Monaco,Consolas,monospace;font-size:14px;line-height:1.5;cursor:pointer;transition:background .2s,transform .2s}
    .output-content:hover{background:#eef6ff}
    .output-content.error{background:#ffebee;color:#c62828}
    .output-content.success{background:#eaf7ee}

    .vars-bar{margin-top:10px;font-size:11px;color:#777;display:flex;align-items:center;gap:6px;cursor:pointer}
    .vars-bar .chev{transition:transform .2s;display:inline-block}
    .vars-bar.open .chev{transform:rotate(90deg)}
    .output-settings{margin-top:10px;padding-top:10px;border-top:2px solid #f0f0f0}
    .output-settings.collapsed{display:none}
    .settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .setting-group{display:flex;flex-direction:column;gap:4px}
    .setting-label{font-size:11px;color:#666}
    .output-settings select,.output-settings input{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;background:#fff}
    .setting-group textarea{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px;min-height:100px;resize:vertical}

    .toast{position:fixed;bottom:30px;right:30px;background:#4CAF50;color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);opacity:0;transform:translateY(12px);transition:all .25s;z-index:1001}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Global Files dropdown panel */
    #globalFilesPanel{display:none;position:relative;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-top:10px}
    #globalFilesPanel.active{display:block}
    #globalFilesList{margin-top:8px;font-size:12px;color:#444}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px dashed #d6d6d6;border-radius:999px;background:#fafafa}
  </style>
  <!-- ===================== END BLOCK C: STYLES ===================================== -->
</head>
<body>
  <div class="container">
    <!-- ===================== BEGIN BLOCK D: HEADER ================================= -->
    <div class="header">
      <div class="title-section">
        <div>
          <h1>PATH</h1>
          <div class="subtitle">Parallel Adaptive Text Helper <span class="badge">v0.25</span></div>
        </div>
      </div>
      <div class="top-actions">
        <button class="link-btn" id="apiKeyBtn" title="OpenAI API Key">üîê API</button>
        <button class="link-btn" id="debugBtn"  title="Toggle debug log">üõ† Debug</button>
        <button class="link-btn" id="filesBtn"  title="Global knowledge files">üìÅ Files</button>
      </div>
    </div>

    <!-- Global Files dropdown (collapsed by default) -->
    <div id="globalFilesPanel">
      <div style="font-weight:600; color:#444; margin-bottom:8px;">Global Knowledge Files</div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="globalFileInput" type="file" multiple />
        <button class="link-btn" id="uploadGlobalBtn" type="button">Upload</button>
        <span class="pill">These files are available to every bot.</span>
      </div>
      <div id="globalFilesList"></div>
    </div>
    <!-- ===================== END BLOCK D: HEADER =================================== -->

    <!-- ===================== BEGIN BLOCK E: INPUT ================================== -->
    <div class="input-section">
      <div class="input-group">
        <label for="prompt" class="sr-only">Enter text</label>
        <textarea id="prompt" placeholder="Type your input‚Ä¶  (Press Enter to run all bots)"></textarea>
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>
    <!-- ===================== END BLOCK E: INPUT ==================================== -->

    <!-- ===================== BEGIN BLOCK F: OUTPUT GRID ============================ -->
    <div class="outputs-grid" id="outputsGrid"></div>
    <!-- ===================== END BLOCK F: OUTPUT GRID ============================== -->
  </div>

  <!-- ===================== BEGIN BLOCK G: API KEY MODAL ============================ -->
  <div id="apiKeyModal" class="modal">
    <div class="modal-content" style="max-width:520px">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h2 class="modal-title" style="margin:0">OpenAI API Key</h2>
        <button class="modal-close link-btn" onclick="closeApiKeyModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-..." />
        <p style="color:#666;font-size:12px;margin-top:8px;">Stored locally in your browser and only sent to OpenAI.</p>
      </div>
      <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="link-btn" onclick="closeApiKeyModal()">Cancel</button>
        <button class="link-btn" style="background:#667eea;color:#fff;border-color:#667eea" onclick="saveApiKey()">Save</button>
      </div>
    </div>
  </div>
  <!-- ===================== END BLOCK G: API KEY MODAL ============================== -->

  <!-- ===================== BEGIN BLOCK H: TOAST ==================================== -->
  <div id="toast" class="toast">Text appended!</div>
  <!-- ===================== END BLOCK H: TOAST ====================================== -->

  <!-- ===================== BEGIN BLOCK I: SCRIPT =================================== -->
  <script>
    /* ---------- State ---------- */
    let outputs = Array(9).fill('');
    let debugMode = false;
    let apiKey = localStorage.getItem('path_api_key') || '';

    /* ---------- Defaults (Name + Persona + Temperature) ---------- */
    const defaultConfigs = Array.from({length:9}, (_,i)=>({
      name: `Bot ${i+1}`,
      model: i===3 || i===8 ? 'gpt-5-mini' : (i===6 ? 'gpt-5-nano' : 'gpt-5'),
      persona: '',           // empty by default (your request)
      temperature: 0.7,      // sensible default
      reasoning: 'minimal',  // still available
      verbosity: 'low',      // still available
      maxtok: 30
    }));

    /* ---------- Helpers ---------- */
    function addDebugLog(message){
      if (!debugMode) return;
      let p = document.getElementById('debugPanel');
      if (!p){
        p = document.createElement('pre');
        p.id = 'debugPanel';
        p.className = 'debug-panel active';
        document.querySelector('.input-section').insertAdjacentElement('afterend', p);
      }
      const ts = new Date().toISOString().substr(11,8);
      p.textContent += `[${ts}] ${message}\n`;
      p.scrollTop = p.scrollHeight;
    }
    function showError(message){
      const el=document.getElementById('errorMessage');
      el.textContent=message; el.classList.add('active');
      setTimeout(()=>el.classList.remove('active'), 5000);
    }
    function showToast(message){
      const t=document.getElementById('toast');
      t.textContent=message; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800);
    }
    function updateApiKeyButton(){
      const btn=document.getElementById('apiKeyBtn');
      if (!btn) return;
      if (apiKey){ btn.classList.add('configured'); btn.textContent='üîê API'; }
      else { btn.classList.remove('configured'); btn.textContent='üîë API'; }
    }
    function openApiKeyModal(){
      document.getElementById('apiKeyModal').classList.add('active');
      document.getElementById('apiKeyInput').value=apiKey;
    }
    function closeApiKeyModal(){
      document.getElementById('apiKeyModal').classList.remove('active');
    }
    function saveApiKey(){
      apiKey=document.getElementById('apiKeyInput').value||'';
      localStorage.setItem('path_api_key', apiKey);
      updateApiKeyButton();
      closeApiKeyModal();
      showToast('API key saved');
    }

    /* ---------- Persist per-bot settings ---------- */
    const VAR_KEYS = ['name','model','persona','temperature','reasoning','verbosity','maxtok'];
    function cardKey(i,k){ return `path_card_${i}_${k}`; }
    function filesKeyGlobal(){ return `path_global_files`; }
    function filesKeyForBot(i){ return `path_card_${i}_files`; }

    function loadCardSettings(index){
      try{
        VAR_KEYS.forEach(k=>{
          const el = document.getElementById(`${k}-${index}`);
          if (!el) return;
          const saved = localStorage.getItem(cardKey(index,k));
          if (saved !== null){
            if (k==='temperature' || k==='maxtok'){ el.value = +saved; }
            else { el.value = saved; }
          }
        });
        renderFileList(document.getElementById(`botFilesList-${index}`), loadFilesForBot(index), 'bot', index);
        updateVarSummary(index);
      }catch(e){ addDebugLog(`Settings load error [${index}]: ${e}`); }
    }
    function handleSettingEvent(e){
      const t=e && e.target; if(!t||!t.id) return;
      const m=t.id.match(/^(name|model|persona|temperature|reasoning|verbosity|maxtok)-(\d+)$/);
      if (!m) return;
      const key=m[1], i=parseInt(m[2],10);
      localStorage.setItem(cardKey(i,key), t.value);
      if (key==='model') applyModelDefaults(i, t.value);
      updateVarSummary(i);
    }
    document.addEventListener('change', handleSettingEvent);
    document.addEventListener('input',  handleSettingEvent);

    /* ---------- Files: global + per-bot (R2 via signed URLs) ---------- */
    function loadGlobalFiles(){ try{ return JSON.parse(localStorage.getItem(filesKeyGlobal())||'[]'); }catch{ return []; } }
    function saveGlobalFiles(list){ localStorage.setItem(filesKeyGlobal(), JSON.stringify(list)); }
    function loadFilesForBot(i){ try{ return JSON.parse(localStorage.getItem(filesKeyForBot(i))||'[]'); }catch{ return []; } }
    function saveFilesForBot(i,list){ localStorage.setItem(filesKeyForBot(i), JSON.stringify(list)); }

    async function uploadToR2(file){
      const res = await fetch('/api/upload-url', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ filename:file.name, contentType:file.type||'text/plain' })
      });
      if(!res.ok) throw new Error('Failed to get signed upload URL');
      const { url, key } = await res.json();
      const put = await fetch(url, { method:'PUT', headers:{'Content-Type': file.type||'text/plain'}, body:file });
      if(!put.ok) throw new Error('Upload to storage failed');
      return { key, name:file.name, size:file.size };
    }
    async function fetchFileTextByKey(key){
      const res = await fetch('/api/file-url?key=' + encodeURIComponent(key), { credentials:'include' });
      if(!res.ok) throw new Error('file-url failed');
      const { url } = await res.json();
      return await fetch(url).then(r=>r.text());
    }
    function renderFileList(container, list, scope, index){
      if (!container) return;
      if (!Array.isArray(list) || list.length===0){ container.innerHTML = `<div style="color:#777">No files.</div>`; return; }
      container.innerHTML = list.map((f, idx)=>`
        <div style="display:flex; gap:8px; align-items:center; padding:6px 0; border-top:1px dashed #eee;">
          <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            <strong>${f.name}</strong> <span style="color:#999">(${f.size||'?'} bytes)</span>
          </div>
          <button class="link-btn" type="button" data-scope="${scope}" data-index="${index||''}" data-fileidx="${idx}" data-act="preview">Preview</button>
          <button class="link-btn" type="button" data-scope="${scope}" data-index="${index||''}" data-fileidx="${idx}" data-act="remove">Remove</button>
        </div>
      `).join('');
    }
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button.link-btn'); if(!btn) return;
      const act = btn.dataset.act; if(!act) return;

      if (act==='preview'){
        const scope=btn.dataset.scope, i=parseInt(btn.dataset.index||'-1',10), fi=parseInt(btn.dataset.fileidx,10);
        const list = scope==='global' ? loadGlobalFiles() : loadFilesForBot(i);
        const file = list[fi]; if (!file) return;
        try{
          const text = await fetchFileTextByKey(file.key);
          alert((text||'').slice(0,2000));
        }catch(err){ alert('Preview failed: '+err.message); }
      }
      if (act==='remove'){
        const scope=btn.dataset.scope, i=parseInt(btn.dataset.index||'-1',10), fi=parseInt(btn.dataset.fileidx,10);
        const list = scope==='global' ? loadGlobalFiles() : loadFilesForBot(i);
        list.splice(fi,1);
        if (scope==='global'){ saveGlobalFiles(list); renderFileList(document.getElementById('globalFilesList'), list, 'global'); }
        else { saveFilesForBot(i, list); renderFileList(document.getElementById(`botFilesList-${i}`), list, 'bot', i); }
      }
    });

    /* ---------- Model defaults ---------- */
    function getModelDefaults(model){
      const m=(model||'').toLowerCase();
      return m.startsWith('gpt-5') ? { reasoning:'minimal', verbosity:'low', maxtok:30 } :
                                     { reasoning:'medium',  verbosity:'medium', maxtok:30 };
    }
    function applyModelDefaults(index, model){
      const d=getModelDefaults(model);
      const rSel=document.getElementById(`reasoning-${index}`);
      const vSel=document.getElementById(`verbosity-${index}`);
      const tInp=document.getElementById(`maxtok-${index}`);
      if (rSel) rSel.value=d.reasoning;
      if (vSel) vSel.value=d.verbosity;
      if (tInp) tInp.value=d.maxtok;
      updateVarSummary(index);
    }

    /* ---------- Cards ---------- */
    function getVarSummary(index){
      const name = document.getElementById(`name-${index}`)?.value || `Bot ${index+1}`;
      const model= document.getElementById(`model-${index}`)?.value || '';
      const temp = document.getElementById(`temperature-${index}`)?.value || '0.7';
      const r    = document.getElementById(`reasoning-${index}`)?.value || '';
      const v    = document.getElementById(`verbosity-${index}`)?.value || '';
      const cap  = document.getElementById(`maxtok-${index}`)?.value || 'auto';
      return `${name} ¬∑ ${model} ¬∑ T:${temp} ¬∑ r:${r} ¬∑ v:${v} ¬∑ cap:${cap}`;
    }
    function updateVarSummary(index){
      const el=document.getElementById(`varssum-${index}`);
      if (el) el.textContent=getVarSummary(index);
    }
    function toggleVars(index){
      const s=document.getElementById(`settings-${index}`);
      const b=document.getElementById(`varsbar-${index}`);
      if (!s||!b) return;
      if (s.classList.contains('collapsed')){ s.classList.remove('collapsed'); b.classList.add('open'); }
      else { s.classList.add('collapsed'); b.classList.remove('open'); }
    }

    function createOutputCard(index){
      const cfg=defaultConfigs[index];
      const card=document.createElement('div');
      card.className='output-card';
      card.id=`output-${index}`;
      card.innerHTML=`
        <div class="num-badge">${index+1}.</div>
        <button class="refresh-btn" id="refresh-${index}" title="Run this bot">‚Üª</button>
        <div class="output-content" id="content-${index}" title="Click to append to prompt">Ready to generate‚Ä¶</div>

        <div class="vars-bar" id="varsbar-${index}">
          <span class="chev">‚ñ∏</span><span id="varssum-${index}"></span>
        </div>

        <div class="output-settings collapsed" id="settings-${index}">
          <div class="settings-grid">

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Bot Name</label>
              <input id="name-${index}" value="${cfg.name}" placeholder="Name this bot" />
            </div>

            <div class="setting-group">
              <label class="setting-label">Model</label>
              <select id="model-${index}">
                <option value="gpt-5" ${cfg.model==='gpt-5'?'selected':''}>gpt-5</option>
                <option value="gpt-5-mini" ${cfg.model==='gpt-5-mini'?'selected':''}>gpt-5-mini</option>
                <option value="gpt-5-nano" ${cfg.model==='gpt-5-nano'?'selected':''}>gpt-5-nano</option>
                <option value="gpt-5-thinking">gpt-5-thinking</option>
                <option value="gpt-5-thinking-mini">gpt-5-thinking-mini</option>
                <option value="gpt-5-thinking-nano">gpt-5-thinking-nano</option>
                <option value="gpt-4-turbo-preview">GPT-4 Turbo (Fallback)</option>
                <option value="gpt-4">GPT-4 (Fallback)</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fallback)</option>
              </select>
            </div>

            <div class="setting-group">
              <label class="setting-label">Temperature <span style="color:#999">(0‚Äì2)</span></label>
              <input id="temperature-${index}" type="number" step="0.1" min="0" max="2" value="${cfg.temperature}" />
            </div>

            <div class="setting-group">
              <label class="setting-label">Reasoning Effort</label>
              <select id="reasoning-${index}">
                <option value="minimal" ${cfg.reasoning==='minimal'?'selected':''}>minimal</option>
                <option value="low"     ${cfg.reasoning==='low'?'selected':''}>low</option>
                <option value="medium"  ${cfg.reasoning==='medium'?'selected':''}>medium</option>
                <option value="high"    ${cfg.reasoning==='high'?'selected':''}>high</option>
              </select>
            </div>

            <div class="setting-group">
              <label class="setting-label">Verbosity</label>
              <select id="verbosity-${index}">
                <option value="low"    ${cfg.verbosity==='low'?'selected':''}>low</option>
                <option value="medium" ${cfg.verbosity==='medium'?'selected':''}>medium</option>
                <option value="high"   ${cfg.verbosity==='high'?'selected':''}>high</option>
              </select>
            </div>

            <div class="setting-group">
              <label class="setting-label">Max tokens (hard cap)</label>
              <input id="maxtok-${index}" type="number" min="1" step="1" value="${cfg.maxtok}" />
            </div>

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Persona</label>
              <textarea id="persona-${index}" placeholder="" style="min-height:140px"></textarea>
            </div>

            <div class="setting-group" style="grid-column:1/-1">
              <label class="setting-label">Bot Files</label>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input id="botFileInput-${index}" type="file" multiple />
                <button type="button" class="link-btn" id="uploadBotBtn-${index}">Upload to this bot</button>
              </div>
              <div id="botFilesList-${index}" style="margin-top:8px; font-size:12px;"></div>
            </div>

          </div>
        </div>
      `;

      // wiring
      card.querySelector(`#refresh-${index}`).addEventListener('click', ()=>refreshOutput(index));
      card.querySelector(`#varsbar-${index}`).addEventListener('click', ()=>toggleVars(index));
      card.querySelector(`#content-${index}`).addEventListener('click', ()=>appendOutput(index));
      const modelSel = card.querySelector(`#model-${index}`);
      modelSel.addEventListener('change', (e)=> applyModelDefaults(index, e.target.value));
      card.querySelector(`#uploadBotBtn-${index}`).addEventListener('click', async ()=>{
        const inp=card.querySelector(`#botFileInput-${index}`); if(!inp||!inp.files||!inp.files.length) return;
        const current=loadFilesForBot(index);
        for(const f of inp.files){ try{ const meta=await uploadToR2(f); current.push(meta); }
          catch(e){ showError('Bot file upload failed: '+e.message); } }
        saveFilesForBot(index,current);
        renderFileList(card.querySelector(`#botFilesList-${index}`), current, 'bot', index);
        inp.value='';
      });

      return card;
    }

    function initializeOutputCards(){
      const grid=document.getElementById('outputsGrid');
      grid.innerHTML='';
      for (let i=0;i<9;i++){
        const card = createOutputCard(i);
        grid.appendChild(card);
        applyModelDefaults(i, defaultConfigs[i].model);
        loadCardSettings(i);
      }
    }

    /* ---------- Build context text from files ---------- */
    async function buildContextText(index){
      const globalFiles = loadGlobalFiles();
      const botFiles    = loadFilesForBot(index);
      const all = [...globalFiles, ...botFiles];
      if (all.length===0) return '';
      let total = 0, parts = [];
      for(const f of all){
        try{
          let t = await fetchFileTextByKey(f.key);
          if (!t) continue;
          t = t.slice(0, 4000);
          total += t.length; if (total > 8000) break;
          parts.push(`--- BEGIN FILE: ${f.name}\n${t}\n--- END FILE: ${f.name}`);
        }catch(e){}
      }
      return parts.join('\n\n');
    }

    /* ---------- API glue ---------- */
    function extractTextFromResponse(responseData){
      try{
        if (responseData?.output_text) return responseData.output_text;
        if (Array.isArray(responseData?.output)){
          const msg = responseData.output.find(x=>x.type==='message');
          if (msg?.content?.length){
            const t = msg.content.find(x=>x.type==='output_text');
            if (t?.text) return t.text;
            return msg.content.map(c=>c.text||c.content||'').join('\n');
          }
        }
        if (Array.isArray(responseData?.choices)){
          return responseData.choices[0]?.message?.content || responseData.choices[0]?.text || '';
        }
      }catch{}
      return '';
    }

    async function refreshOutput(index){
      if (!apiKey){ openApiKeyModal(); return; }

      const out  = document.getElementById(`content-${index}`);
      const name = document.getElementById(`name-${index}`).value || `Bot ${index+1}`;
      const model= document.getElementById(`model-${index}`).value;
      const temp = parseFloat(document.getElementById(`temperature-${index}`).value||'0.7');
      const reas = document.getElementById(`reasoning-${index}`).value;
      const verb = document.getElementById(`verbosity-${index}`).value;
      const cap  = parseInt(document.getElementById(`maxtok-${index}`).value||'0',10) || null;
      const persona = document.getElementById(`persona-${index}`).value || '';
      const prompt = document.getElementById('prompt').value || '';

      const btn=document.getElementById(`refresh-${index}`);
      btn.classList.add('spinning');
      out.classList.remove('error','success');
      out.textContent = `${name} is thinking‚Ä¶`;

      try{
        const filesContext = await buildContextText(index);
        const sys = persona ? persona : 'You are a helpful assistant.';
        const userMsg = (filesContext ? `You may consult these references:\n\n${filesContext}\n\n` : '') +
                        (prompt ? `User input:\n${prompt}` : 'No additional user input was provided.');

        let textOut = '';
        if (model.startsWith('gpt-5')){
          const body = { model, input: `${sys}\n\n${userMsg}`, temperature: temp, reasoning:{effort: reas}, text:{verbosity: verb} };
          if (cap) body.max_output_tokens = cap;
          const r = await fetch('https://api.openai.com/v1/responses', {
            method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'}, body: JSON.stringify(body)
          });
          const raw = await r.text(); let data; try{ data=JSON.parse(raw);}catch{ data={output_text:raw}; }
          if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
          textOut = (extractTextFromResponse(data)||'').trim();
        } else {
          const body = { model,
            messages: [
              { role:'system', content: sys },
              { role:'user',   content: userMsg }
            ],
            temperature: temp
          };
          if (cap) body.max_tokens = cap;
          const r = await fetch('https://api.openai.com/v1/chat/completions', {
            method:'POST', headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'}, body: JSON.stringify(body)
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data?.error?.message || `HTTP ${r.status}`);
          textOut = (data?.choices?.[0]?.message?.content||'').trim();
        }

        outputs[index] = textOut || 'No output';
        out.textContent = outputs[index];
        out.classList.add('success');
      }catch(err){
        out.textContent = `Error: ${err.message||String(err)}`;
        out.classList.add('error');
      }finally{
        btn.classList.remove('spinning');
      }
    }

    async function generateOutputs(){
      if (!apiKey){ openApiKeyModal(); return; }
      const prompt=document.getElementById('prompt').value.trim();
      if (!prompt){ showError('Please enter text'); return; }
      const tasks=[];
      for (let i=0;i<9;i++){
        document.getElementById(`content-${i}`).textContent='Generating‚Ä¶';
        tasks.push(refreshOutput(i));
      }
      await Promise.all(tasks);
    }

    function appendOutput(index){
      if (!outputs[index]) return;
      const prompt=document.getElementById('prompt');
      const sep = prompt.value.trim() ? ' // ' : '';
      prompt.value += sep + outputs[index];
      prompt.scrollTop = prompt.scrollHeight;
      showToast('Text appended to prompt');
    }

    /* ---------- Global UI wiring ---------- */
    window.addEventListener('DOMContentLoaded', ()=>{
      // buttons
      document.getElementById('apiKeyBtn').addEventListener('click', openApiKeyModal);
      document.getElementById('debugBtn').addEventListener('click', ()=>{
        debugMode = !debugMode;
        let p = document.getElementById('debugPanel');
        if (debugMode && !p){ p = document.createElement('pre'); p.id='debugPanel'; p.className='debug-panel active'; document.querySelector('.input-section').insertAdjacentElement('afterend', p); }
        if (p){ p.classList.toggle('active', debugMode); }
      });
      document.getElementById('filesBtn').addEventListener('click', ()=>{
        document.getElementById('globalFilesPanel').classList.toggle('active');
      });

      // global files list + uploader
      renderFileList(document.getElementById('globalFilesList'), loadGlobalFiles(), 'global');
      const gBtn = document.getElementById('uploadGlobalBtn');
      const gInp = document.getElementById('globalFileInput');
      if (gBtn && gInp){
        gBtn.addEventListener('click', async ()=>{
          if (!gInp.files || !gInp.files.length) return;
          const cur = loadGlobalFiles();
          for(const f of gInp.files){ try{ const meta=await uploadToR2(f); cur.push(meta); }catch(e){ showError('Global upload failed: '+e.message); } }
          saveGlobalFiles(cur);
          renderFileList(document.getElementById('globalFilesList'), cur, 'global');
          gInp.value='';
        });
      }

      // enter key = run all
      const ta = document.getElementById('prompt');
      ta.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey){
          e.preventDefault(); generateOutputs();
        }
      });

      // build cards
      initializeOutputCards();
      updateApiKeyButton();
    });

    // numeric hotkeys 1..9 to append
    document.addEventListener('keydown', (e)=>{
      const ae=document.activeElement; const tag=(ae && ae.tagName||'').toLowerCase();
      const isOtherInput = (tag==='input') || (tag==='textarea' && ae.id!=='prompt') || (ae && ae.isContentEditable);
      if (isOtherInput || e.ctrlKey||e.metaKey||e.altKey) return;
      const k=e.key; if (k>='1'&&k<='9'){ e.preventDefault(); appendOutput(parseInt(k,10)-1); }
    });
  </script>
  <!-- ===================== END BLOCK I: SCRIPT ===================================== -->
</body>
</html>
